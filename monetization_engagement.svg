<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="4099px" preserveAspectRatio="none" style="width:1825px;height:4099px;background:#FFFFFF;" version="1.1" viewBox="0 0 1825 4099" width="1825px" zoomAndPan="magnify"><defs/><g><rect fill="#FFFFFF" height="35.6094" id="_title" style="stroke:#FFFFFF;stroke-width:0.0;" width="1073" x="374.75" y="10"/><text fill="#000000" font-family="Verdana" font-size="22" font-weight="bold" lengthAdjust="spacing" textLength="1063" x="379.75" y="35.4209">Telegram Fitness Bot - Monetization &amp; Engagement — Sequence (Charts + AI Coach)</text><rect fill="#FFFFFF" height="490.0625" style="stroke:#000000;stroke-width:1.0;" width="1667.5" x="25" y="465.2344"/><rect fill="#FFFFFF" height="49.9375" style="stroke:none;stroke-width:1.0;" width="1667.5" x="25" y="905.3594"/><rect fill="#FFFFFF" height="266.1328" style="stroke:#000000;stroke-width:1.0;" width="1667.5" x="25" y="1507.6875"/><rect fill="#FFFFFF" height="161.6016" style="stroke:none;stroke-width:1.0;" width="1667.5" x="25" y="1612.2188"/><rect fill="#FFFFFF" height="604.5313" style="stroke:#000000;stroke-width:1.0;" width="1687.5" x="15" y="2157.4141"/><rect fill="#FFFFFF" height="266.1328" style="stroke:#000000;stroke-width:1.0;" width="1667.5" x="25" y="2268.9453"/><rect fill="#FFFFFF" height="161.6016" style="stroke:none;stroke-width:1.0;" width="1667.5" x="25" y="2373.4766"/><rect fill="#FFFFFF" height="219.8672" style="stroke:none;stroke-width:1.0;" width="1687.5" x="15" y="2542.0781"/><rect fill="#FFFFFF" height="409.6641" style="stroke:#000000;stroke-width:1.0;" width="1514" x="178.5" y="2877.3438"/><rect fill="#FFFFFF" height="160.4688" style="stroke:none;stroke-width:1.0;" width="1514" x="178.5" y="3126.5391"/><rect fill="#FFFFFF" height="627.7266" style="stroke:#000000;stroke-width:1.0;" width="1783.5" x="25" y="3373.2734"/><rect fill="#FFFFFF" height="49.9375" style="stroke:none;stroke-width:1.0;" width="1783.5" x="25" y="3951.0625"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="54" x2="54" y1="128.9063" y2="4018"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="237.5" x2="237.5" y1="128.9063" y2="4018"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="544.5" x2="544.5" y1="128.9063" y2="4018"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="738.5" x2="738.5" y1="128.9063" y2="4018"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="896.5" x2="896.5" y1="128.9063" y2="4018"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1062.5" x2="1062.5" y1="128.9063" y2="4018"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1216.5" x2="1216.5" y1="128.9063" y2="4018"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1369.5" x2="1369.5" y1="128.9063" y2="4018"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1664.5" x2="1664.5" y1="128.9063" y2="4018"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1745.5" x2="1745.5" y1="128.9063" y2="4018"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="32" x="35" y="125.6045">User</text><ellipse cx="54" cy="60.6094" fill="#FFFFFF" rx="8" ry="8" style="stroke:#000000;stroke-width:1.0;"/><path d="M54,68.6094 L54,95.6094 M41,76.6094 L67,76.6094 M54,95.6094 L41,110.6094 M54,95.6094 L67,110.6094 " fill="none" style="stroke:#000000;stroke-width:1.0;"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="32" x="35" y="4029.9951">User</text><ellipse cx="54" cy="4042.2969" fill="#FFFFFF" rx="8" ry="8" style="stroke:#000000;stroke-width:1.0;"/><path d="M54,4050.2969 L54,4077.2969 M41,4058.2969 L67,4058.2969 M54,4077.2969 L41,4092.2969 M54,4077.2969 L67,4092.2969 " fill="none" style="stroke:#000000;stroke-width:1.0;"/><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="79" x="198.5" y="97.6094"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="65" x="205.5" y="117.6045">Telegram</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="79" x="198.5" y="4017"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="65" x="205.5" y="4036.9951">Telegram</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="75" x="507.5" y="97.6094"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="61" x="514.5" y="117.6045">Handlers</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="75" x="507.5" y="4017"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="61" x="514.5" y="4036.9951">Handlers</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="105" x="686.5" y="97.6094"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="91" x="693.5" y="117.6045">WalletService</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="105" x="686.5" y="4017"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="91" x="693.5" y="4036.9951">WalletService</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="150" x="821.5" y="97.6094"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="136" x="828.5" y="117.6045">SubscriptionService</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="150" x="821.5" y="4017"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="136" x="828.5" y="4036.9951">SubscriptionService</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="122" x="1001.5" y="97.6094"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="108" x="1008.5" y="117.6045">ProgramService</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="122" x="1001.5" y="4017"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="108" x="1008.5" y="4036.9951">ProgramService</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="126" x="1153.5" y="97.6094"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="112" x="1160.5" y="117.6045">ProgressService</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="126" x="1153.5" y="4017"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="112" x="1160.5" y="4036.9951">ProgressService</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="120" x="1309.5" y="97.6094"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="106" x="1316.5" y="117.6045">AICoachService</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="120" x="1309.5" y="4017"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="106" x="1316.5" y="4036.9951">AICoachService</text><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="21" x="1651" y="125.6045">DB</text><path d="M1646.5,76.6094 C1646.5,66.6094 1664.5,66.6094 1664.5,66.6094 C1664.5,66.6094 1682.5,66.6094 1682.5,76.6094 L1682.5,102.6094 C1682.5,112.6094 1664.5,112.6094 1664.5,112.6094 C1664.5,112.6094 1646.5,112.6094 1646.5,102.6094 L1646.5,76.6094 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.5;"/><path d="M1646.5,76.6094 C1646.5,86.6094 1664.5,86.6094 1664.5,86.6094 C1664.5,86.6094 1682.5,86.6094 1682.5,76.6094 " fill="none" style="stroke:#000000;stroke-width:1.5;"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="21" x="1651" y="4029.9951">DB</text><path d="M1646.5,4043.2969 C1646.5,4033.2969 1664.5,4033.2969 1664.5,4033.2969 C1664.5,4033.2969 1682.5,4033.2969 1682.5,4043.2969 L1682.5,4069.2969 C1682.5,4079.2969 1664.5,4079.2969 1664.5,4079.2969 C1664.5,4079.2969 1646.5,4079.2969 1646.5,4069.2969 L1646.5,4043.2969 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.5;"/><path d="M1646.5,4043.2969 C1646.5,4053.2969 1664.5,4053.2969 1664.5,4053.2969 C1664.5,4053.2969 1682.5,4053.2969 1682.5,4043.2969 " fill="none" style="stroke:#000000;stroke-width:1.5;"/><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="86" x="1702.5" y="97.6094"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="72" x="1709.5" y="117.6045">AI Provider</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="86" x="1702.5" y="4017"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="72" x="1709.5" y="4036.9951">AI Provider</text><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1.0;" width="1813.5" x="5" y="159.4727"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1818.5" y1="159.4727" y2="159.4727"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1818.5" y1="162.4727" y2="162.4727"/><rect fill="#FFFFFF" height="23.1328" style="stroke:#000000;stroke-width:1.0;" width="65" x="879.25" y="148.9063"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="46" x="885.25" y="164.9731">Wallet</text><polygon fill="#000000" points="226,199.1719,236,203.1719,226,207.1719,230,203.1719" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="54" x2="232" y1="203.1719" y2="203.1719"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="48" x="61" y="198.106">Баланс</text><polygon fill="#000000" points="533,228.3047,543,232.3047,533,236.3047,537,232.3047" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="238" x2="539" y1="232.3047" y2="232.3047"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="111" x="245" y="227.2388">cb(wallet_screen)</text><polygon fill="#000000" points="727,257.4375,737,261.4375,727,265.4375,731,261.4375" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="545" x2="733" y1="261.4375" y2="261.4375"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="170" x="552" y="256.3716">get_or_create_wallet(user)</text><polygon fill="#000000" points="1652.5,286.5703,1662.5,290.5703,1652.5,294.5703,1656.5,290.5703" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="739" x2="1658.5" y1="290.5703" y2="290.5703"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="123" x="746" y="285.5044">wallet upsert/select</text><polygon fill="#000000" points="750,315.7031,740,319.7031,750,323.7031,746,319.7031" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="744" x2="1663.5" y1="319.7031" y2="319.7031"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="36" x="756" y="314.6372">wallet</text><polygon fill="#000000" points="556,344.8359,546,348.8359,556,352.8359,552,348.8359" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="550" x2="738" y1="348.8359" y2="348.8359"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="36" x="562" y="343.77">wallet</text><polygon fill="#000000" points="249,373.9688,239,377.9688,249,381.9688,245,377.9688" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="243" x2="544" y1="377.9688" y2="377.9688"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="186" x="255" y="372.9028">show wallet(balance, actions)</text><polygon fill="#000000" points="65,403.1016,55,407.1016,65,411.1016,61,407.1016" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="59" x2="237" y1="407.1016" y2="407.1016"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="36" x="71" y="402.0356">wallet</text><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1.0;" width="1813.5" x="5" y="435.668"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1818.5" y1="435.668" y2="435.668"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1818.5" y1="438.668" y2="438.668"/><rect fill="#FFFFFF" height="23.1328" style="stroke:#000000;stroke-width:1.0;" width="234" x="794.75" y="425.1016"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="215" x="800.75" y="441.1685">Top-up (Telegram Payments)</text><path d="M25,465.2344 L89,465.2344 L89,472.3672 L79,482.3672 L25,482.3672 L25,465.2344 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="490.0625" style="stroke:#000000;stroke-width:1.0;" width="1667.5" x="25" y="465.2344"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="40" y="478.3013">alt</text><text fill="#000000" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="142" x="104" y="477.4448">[PAYMENTS_ENABLED]</text><polygon fill="#000000" points="226,499.5,236,503.5,226,507.5,230,503.5" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="54" x2="232" y1="503.5" y2="503.5"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="74" x="61" y="498.4341">Пополнить</text><polygon fill="#000000" points="533,528.6328,543,532.6328,533,536.6328,537,532.6328" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="238" x2="539" y1="532.6328" y2="532.6328"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="62" x="245" y="527.5669">cb(topup)</text><polygon fill="#000000" points="727,557.7656,737,561.7656,727,565.7656,731,561.7656" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="545" x2="733" y1="561.7656" y2="561.7656"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="156" x="552" y="556.6997">create_invoice(package)</text><polygon fill="#000000" points="556,586.8984,546,590.8984,556,594.8984,552,590.8984" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="550" x2="738" y1="590.8984" y2="590.8984"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="98" x="562" y="585.8325">invoice payload</text><polygon fill="#000000" points="249,616.0313,239,620.0313,249,624.0313,245,620.0313" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="243" x2="544" y1="620.0313" y2="620.0313"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="142" x="255" y="614.9653">send_invoice(payload)</text><polygon fill="#000000" points="65,645.1641,55,649.1641,65,653.1641,61,649.1641" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="59" x2="237" y1="649.1641" y2="649.1641"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="74" x="71" y="644.0981">payment UI</text><polygon fill="#000000" points="533,674.2969,543,678.2969,533,682.2969,537,678.2969" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="238" x2="539" y1="678.2969" y2="678.2969"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="129" x="245" y="673.231">pre_checkout_query</text><polygon fill="#000000" points="249,703.4297,239,707.4297,249,711.4297,245,707.4297" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="243" x2="544" y1="707.4297" y2="707.4297"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="163" x="255" y="702.3638">answer_pre_checkout(ok)</text><polygon fill="#000000" points="533,732.5625,543,736.5625,533,740.5625,537,736.5625" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="238" x2="539" y1="736.5625" y2="736.5625"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="190" x="245" y="731.4966">successful_payment(payload)</text><polygon fill="#000000" points="727,761.6953,737,765.6953,727,769.6953,731,765.6953" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="545" x2="733" y1="765.6953" y2="765.6953"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="138" x="552" y="760.6294">apply_topup(payload)</text><polygon fill="#000000" points="1652.5,805.9609,1662.5,809.9609,1652.5,813.9609,1656.5,809.9609" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="739" x2="1658.5" y1="809.9609" y2="809.9609"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="138" x="746" y="789.7622">insert tx(type=topup)</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="137" x="746" y="804.895">+ update wallet coins</text><polygon fill="#000000" points="750,835.0938,740,839.0938,750,843.0938,746,839.0938" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="744" x2="1663.5" y1="839.0938" y2="839.0938"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="15" x="756" y="834.0278">ok</text><polygon fill="#000000" points="556,864.2266,546,868.2266,556,872.2266,552,868.2266" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="550" x2="738" y1="868.2266" y2="868.2266"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="15" x="562" y="863.1606">ok</text><polygon fill="#000000" points="249,893.3594,239,897.3594,249,901.3594,245,897.3594" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="243" x2="544" y1="897.3594" y2="897.3594"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="252" x="255" y="892.2935">refresh wallet_screen(updated balance)</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="25" x2="1692.5" y1="906.3594" y2="906.3594"/><text fill="#000000" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="131" x="30" y="916.5698">[Payments disabled]</text><path d="M438,925.1641 L438,950.1641 L651,950.1641 L651,935.1641 L641,925.1641 L438,925.1641 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><path d="M641,925.1641 L641,935.1641 L651,935.1641 L641,925.1641 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="192" x="444" y="942.231">show info / hide topup buttons</text><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1.0;" width="1813.5" x="5" y="982.8633"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1818.5" y1="982.8633" y2="982.8633"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1818.5" y1="985.8633" y2="985.8633"/><rect fill="#FFFFFF" height="23.1328" style="stroke:#000000;stroke-width:1.0;" width="166" x="828.75" y="972.2969"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="147" x="834.75" y="988.3638">Subscription (coins)</text><polygon fill="#000000" points="226,1022.5625,236,1026.5625,226,1030.5625,230,1026.5625" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="54" x2="232" y1="1026.5625" y2="1026.5625"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="66" x="61" y="1021.4966">Подписка</text><polygon fill="#000000" points="533,1051.6953,543,1055.6953,533,1059.6953,537,1055.6953" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="238" x2="539" y1="1055.6953" y2="1055.6953"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="152" x="245" y="1050.6294">cb(subscription_screen)</text><polygon fill="#000000" points="884.5,1080.8281,894.5,1084.8281,884.5,1088.8281,888.5,1084.8281" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="545" x2="890.5" y1="1084.8281" y2="1084.8281"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="106" x="552" y="1079.7622">get_status(user)</text><polygon fill="#000000" points="1652.5,1109.9609,1662.5,1113.9609,1652.5,1117.9609,1656.5,1113.9609" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="896.5" x2="1658.5" y1="1113.9609" y2="1113.9609"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="119" x="903.5" y="1108.895">select subscription</text><polygon fill="#000000" points="907.5,1139.0938,897.5,1143.0938,907.5,1147.0938,903.5,1143.0938" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="901.5" x2="1663.5" y1="1143.0938" y2="1143.0938"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="74" x="913.5" y="1138.0278">active/none</text><polygon fill="#000000" points="556,1168.2266,546,1172.2266,556,1176.2266,552,1172.2266" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="550" x2="895.5" y1="1172.2266" y2="1172.2266"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="40" x="562" y="1167.1606">status</text><polygon fill="#000000" points="727,1197.3594,737,1201.3594,727,1205.3594,731,1201.3594" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="545" x2="733" y1="1201.3594" y2="1201.3594"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="102" x="552" y="1196.2935">get_wallet(user)</text><polygon fill="#000000" points="1652.5,1226.4922,1662.5,1230.4922,1652.5,1234.4922,1656.5,1230.4922" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="739" x2="1658.5" y1="1230.4922" y2="1230.4922"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="78" x="746" y="1225.4263">select wallet</text><polygon fill="#000000" points="750,1255.625,740,1259.625,750,1263.625,746,1259.625" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="744" x2="1663.5" y1="1259.625" y2="1259.625"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="36" x="756" y="1254.5591">wallet</text><polygon fill="#000000" points="556,1284.7578,546,1288.7578,556,1292.7578,552,1288.7578" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="550" x2="738" y1="1288.7578" y2="1288.7578"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="36" x="562" y="1283.6919">wallet</text><polygon fill="#000000" points="249,1313.8906,239,1317.8906,249,1321.8906,245,1317.8906" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="243" x2="544" y1="1317.8906" y2="1317.8906"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="239" x="255" y="1312.8247">show subscription(status, buy/cancel)</text><polygon fill="#000000" points="65,1343.0234,55,1347.0234,65,1351.0234,61,1347.0234" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="59" x2="237" y1="1347.0234" y2="1347.0234"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="77" x="71" y="1341.9575">subscription</text><polygon fill="#000000" points="226,1372.1563,236,1376.1563,226,1380.1563,230,1376.1563" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="54" x2="232" y1="1376.1563" y2="1376.1563"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="49" x="61" y="1371.0903">Купить</text><polygon fill="#000000" points="533,1401.2891,543,1405.2891,533,1409.2891,537,1405.2891" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="238" x2="539" y1="1405.2891" y2="1405.2891"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="132" x="245" y="1400.2231">cb(buy_subscription)</text><polygon fill="#000000" points="884.5,1430.4219,894.5,1434.4219,884.5,1438.4219,888.5,1434.4219" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="545" x2="890.5" y1="1434.4219" y2="1434.4219"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="161" x="552" y="1429.356">purchase_for_coins(user)</text><polygon fill="#000000" points="1652.5,1459.5547,1662.5,1463.5547,1652.5,1467.5547,1656.5,1463.5547" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="896.5" x2="1658.5" y1="1463.5547" y2="1463.5547"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="107" x="903.5" y="1458.4888">lock/select wallet</text><polygon fill="#000000" points="907.5,1488.6875,897.5,1492.6875,907.5,1496.6875,903.5,1492.6875" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="901.5" x2="1663.5" y1="1492.6875" y2="1492.6875"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="36" x="913.5" y="1487.6216">wallet</text><path d="M25,1507.6875 L89,1507.6875 L89,1514.8203 L79,1524.8203 L25,1524.8203 L25,1507.6875 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="266.1328" style="stroke:#000000;stroke-width:1.0;" width="1667.5" x="25" y="1507.6875"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="40" y="1520.7544">alt</text><text fill="#000000" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="122" x="104" y="1519.8979">[Not enough coins]</text><polygon fill="#000000" points="556,1541.9531,546,1545.9531,556,1549.9531,552,1545.9531" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="550" x2="895.5" y1="1545.9531" y2="1545.9531"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="198" x="562" y="1540.8872">error("Недостаточно монет")</text><polygon fill="#000000" points="249,1571.0859,239,1575.0859,249,1579.0859,245,1575.0859" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="243" x2="544" y1="1575.0859" y2="1575.0859"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="147" x="255" y="1570.02">show wallet_topup_hint</text><polygon fill="#000000" points="65,1600.2188,55,1604.2188,65,1608.2188,61,1604.2188" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="59" x2="237" y1="1604.2188" y2="1604.2188"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="24" x="71" y="1599.1528">hint</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="25" x2="1692.5" y1="1613.2188" y2="1613.2188"/><text fill="#000000" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="96" x="30" y="1623.4292">[Enough coins]</text><polygon fill="#000000" points="1652.5,1674.4219,1662.5,1678.4219,1652.5,1682.4219,1656.5,1678.4219" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="896.5" x2="1658.5" y1="1678.4219" y2="1678.4219"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="95" x="903.5" y="1643.0903">insert spend tx</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="100" x="903.5" y="1658.2231">+ update wallet</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="219" x="903.5" y="1673.356">+ upsert subscription(active_until)</text><polygon fill="#000000" points="907.5,1703.5547,897.5,1707.5547,907.5,1711.5547,903.5,1707.5547" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="901.5" x2="1663.5" y1="1707.5547" y2="1707.5547"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="15" x="913.5" y="1702.4888">ok</text><polygon fill="#000000" points="556,1732.6875,546,1736.6875,556,1740.6875,552,1736.6875" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="550" x2="895.5" y1="1736.6875" y2="1736.6875"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="15" x="562" y="1731.6216">ok</text><polygon fill="#000000" points="249,1761.8203,239,1765.8203,249,1769.8203,245,1765.8203" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="243" x2="544" y1="1765.8203" y2="1765.8203"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="283" x="255" y="1760.7544">refresh subscription_screen(updated status)</text><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1.0;" width="1813.5" x="5" y="1801.3867"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1818.5" y1="1801.3867" y2="1801.3867"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1818.5" y1="1804.3867" y2="1804.3867"/><rect fill="#FFFFFF" height="23.1328" style="stroke:#000000;stroke-width:1.0;" width="91" x="866.25" y="1790.8203"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="72" x="872.25" y="1806.8872">Programs</text><path d="M906,1828.9531 L906,1853.9531 L1219,1853.9531 L1219,1838.9531 L1209,1828.9531 L906,1828.9531 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><path d="M1209,1828.9531 L1209,1838.9531 L1219,1838.9531 L1209,1828.9531 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="292" x="912" y="1846.02">Program data is seeded from YAML at startup</text><polygon fill="#000000" points="226,1876.2188,236,1880.2188,226,1884.2188,230,1880.2188" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="54" x2="232" y1="1880.2188" y2="1880.2188"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="76" x="61" y="1875.1528">Программы</text><polygon fill="#000000" points="533,1905.3516,543,1909.3516,533,1913.3516,537,1909.3516" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="238" x2="539" y1="1909.3516" y2="1909.3516"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="137" x="245" y="1904.2856">cb(programs_screen)</text><polygon fill="#000000" points="1050.5,1934.4844,1060.5,1938.4844,1050.5,1942.4844,1054.5,1938.4844" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="545" x2="1056.5" y1="1938.4844" y2="1938.4844"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="125" x="552" y="1933.4185">list_programs(user)</text><polygon fill="#000000" points="1652.5,1963.6172,1662.5,1967.6172,1652.5,1971.6172,1656.5,1967.6172" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1062.5" x2="1658.5" y1="1967.6172" y2="1967.6172"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="229" x="1069.5" y="1962.5513">select programs + ownership/prices</text><polygon fill="#000000" points="1073.5,1992.75,1063.5,1996.75,1073.5,2000.75,1069.5,1996.75" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1067.5" x2="1663.5" y1="1996.75" y2="1996.75"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="18" x="1079.5" y="1991.6841">list</text><polygon fill="#000000" points="556,2021.8828,546,2025.8828,556,2029.8828,552,2025.8828" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="550" x2="1061.5" y1="2025.8828" y2="2025.8828"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="18" x="562" y="2020.8169">list</text><polygon fill="#000000" points="249,2051.0156,239,2055.0156,249,2059.0156,245,2055.0156" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="243" x2="544" y1="2055.0156" y2="2055.0156"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="180" x="255" y="2049.9497">show programs_list(catalog)</text><polygon fill="#000000" points="65,2080.1484,55,2084.1484,65,2088.1484,61,2084.1484" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="59" x2="237" y1="2084.1484" y2="2084.1484"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="47" x="71" y="2079.0825">catalog</text><polygon fill="#000000" points="226,2109.2813,236,2113.2813,226,2117.2813,230,2113.2813" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="54" x2="232" y1="2113.2813" y2="2113.2813"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="160" x="61" y="2108.2153">Купить / Активировать</text><polygon fill="#000000" points="533,2138.4141,543,2142.4141,533,2146.4141,537,2142.4141" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="238" x2="539" y1="2142.4141" y2="2142.4141"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="207" x="245" y="2137.3481">cb(program_action, program_id)</text><path d="M15,2157.4141 L79,2157.4141 L79,2164.5469 L69,2174.5469 L15,2174.5469 L15,2157.4141 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="604.5313" style="stroke:#000000;stroke-width:1.0;" width="1687.5" x="15" y="2157.4141"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="30" y="2170.481">alt</text><text fill="#000000" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="147" x="94" y="2169.6245">[action == buy (coins)]</text><polygon fill="#000000" points="1050.5,2191.6797,1060.5,2195.6797,1050.5,2199.6797,1054.5,2195.6797" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="545" x2="1056.5" y1="2195.6797" y2="2195.6797"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="268" x="552" y="2190.6138">buy_program_for_coins(user, program_id)</text><polygon fill="#000000" points="1652.5,2220.8125,1662.5,2224.8125,1652.5,2228.8125,1656.5,2224.8125" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1062.5" x2="1658.5" y1="2224.8125" y2="2224.8125"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="78" x="1069.5" y="2219.7466">select wallet</text><polygon fill="#000000" points="1073.5,2249.9453,1063.5,2253.9453,1073.5,2257.9453,1069.5,2253.9453" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1067.5" x2="1663.5" y1="2253.9453" y2="2253.9453"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="36" x="1079.5" y="2248.8794">wallet</text><path d="M25,2268.9453 L89,2268.9453 L89,2276.0781 L79,2286.0781 L25,2286.0781 L25,2268.9453 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="266.1328" style="stroke:#000000;stroke-width:1.0;" width="1667.5" x="25" y="2268.9453"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="40" y="2282.0122">alt</text><text fill="#000000" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="122" x="104" y="2281.1558">[Not enough coins]</text><polygon fill="#000000" points="556,2303.2109,546,2307.2109,556,2311.2109,552,2307.2109" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="550" x2="1061.5" y1="2307.2109" y2="2307.2109"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="198" x="562" y="2302.145">error("Недостаточно монет")</text><polygon fill="#000000" points="249,2332.3438,239,2336.3438,249,2340.3438,245,2336.3438" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="243" x2="544" y1="2336.3438" y2="2336.3438"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="147" x="255" y="2331.2778">show wallet_topup_hint</text><polygon fill="#000000" points="65,2361.4766,55,2365.4766,65,2369.4766,61,2365.4766" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="59" x2="237" y1="2365.4766" y2="2365.4766"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="24" x="71" y="2360.4106">hint</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="25" x2="1692.5" y1="2374.4766" y2="2374.4766"/><text fill="#000000" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="96" x="30" y="2384.687">[Enough coins]</text><polygon fill="#000000" points="1652.5,2435.6797,1662.5,2439.6797,1652.5,2443.6797,1656.5,2439.6797" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1062.5" x2="1658.5" y1="2439.6797" y2="2439.6797"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="95" x="1069.5" y="2404.3481">insert spend tx</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="100" x="1069.5" y="2419.481">+ update wallet</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="152" x="1069.5" y="2434.6138">+ mark program owned</text><polygon fill="#000000" points="1073.5,2464.8125,1063.5,2468.8125,1073.5,2472.8125,1069.5,2468.8125" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1067.5" x2="1663.5" y1="2468.8125" y2="2468.8125"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="15" x="1079.5" y="2463.7466">ok</text><polygon fill="#000000" points="556,2493.9453,546,2497.9453,556,2501.9453,552,2497.9453" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="550" x2="1061.5" y1="2497.9453" y2="2497.9453"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="67" x="562" y="2492.8794">purchased</text><polygon fill="#000000" points="249,2523.0781,239,2527.0781,249,2531.0781,245,2527.0781" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="243" x2="544" y1="2527.0781" y2="2527.0781"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="250" x="255" y="2522.0122">refresh programs_list(updated catalog)</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="15" x2="1702.5" y1="2543.0781" y2="2543.0781"/><text fill="#000000" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="128" x="20" y="2553.2886">[action == activate]</text><polygon fill="#000000" points="1050.5,2574.0156,1060.5,2578.0156,1050.5,2582.0156,1054.5,2578.0156" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="545" x2="1056.5" y1="2578.0156" y2="2578.0156"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="232" x="552" y="2572.9497">activate_program(user, program_id)</text><polygon fill="#000000" points="1652.5,2633.4141,1662.5,2637.4141,1652.5,2641.4141,1656.5,2637.4141" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1062.5" x2="1658.5" y1="2637.4141" y2="2637.4141"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="161" x="1069.5" y="2602.0825">set previous active=false</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="143" x="1069.5" y="2617.2153">+ set new active=true</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="180" x="1069.5" y="2632.3481">+ set current_week/day_key</text><polygon fill="#000000" points="1073.5,2662.5469,1063.5,2666.5469,1073.5,2670.5469,1069.5,2666.5469" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1067.5" x2="1663.5" y1="2666.5469" y2="2666.5469"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="15" x="1079.5" y="2661.481">ok</text><polygon fill="#000000" points="556,2691.6797,546,2695.6797,556,2699.6797,552,2695.6797" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="550" x2="1061.5" y1="2695.6797" y2="2695.6797"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="59" x="562" y="2690.6138">activated</text><polygon fill="#000000" points="249,2720.8125,239,2724.8125,249,2728.8125,245,2724.8125" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="243" x2="544" y1="2724.8125" y2="2724.8125"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="282" x="255" y="2719.7466">show success("Программа активирована")</text><polygon fill="#000000" points="65,2749.9453,55,2753.9453,65,2757.9453,61,2753.9453" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="59" x2="237" y1="2753.9453" y2="2753.9453"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="51" x="71" y="2748.8794">success</text><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1.0;" width="1813.5" x="5" y="2789.5117"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1818.5" y1="2789.5117" y2="2789.5117"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1818.5" y1="2792.5117" y2="2792.5117"/><rect fill="#FFFFFF" height="23.1328" style="stroke:#000000;stroke-width:1.0;" width="148" x="837.75" y="2778.9453"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="129" x="843.75" y="2795.0122">Progress / Charts</text><polygon fill="#000000" points="226,2829.2109,236,2833.2109,226,2837.2109,230,2833.2109" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="54" x2="232" y1="2833.2109" y2="2833.2109"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="62" x="61" y="2828.145">Прогресс</text><polygon fill="#000000" points="533,2858.3438,543,2862.3438,533,2866.3438,537,2862.3438" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="238" x2="539" y1="2862.3438" y2="2862.3438"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="131" x="245" y="2857.2778">cb(progress_screen)</text><path d="M178.5,2877.3438 L242.5,2877.3438 L242.5,2884.4766 L232.5,2894.4766 L178.5,2894.4766 L178.5,2877.3438 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="409.6641" style="stroke:#000000;stroke-width:1.0;" width="1514" x="178.5" y="2877.3438"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="193.5" y="2890.4106">alt</text><text fill="#000000" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="124" x="257.5" y="2889.5542">[CHARTS_ENABLED]</text><polygon fill="#000000" points="1204.5,2911.6094,1214.5,2915.6094,1204.5,2919.6094,1208.5,2915.6094" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="545" x2="1210.5" y1="2915.6094" y2="2915.6094"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="177" x="552" y="2910.5435">build_progress_report(user)</text><polygon fill="#000000" points="1652.5,2940.7422,1662.5,2944.7422,1652.5,2948.7422,1656.5,2944.7422" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1216.5" x2="1658.5" y1="2944.7422" y2="2944.7422"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="194" x="1223.5" y="2939.6763">load workouts/sets/weight logs</text><polygon fill="#000000" points="1227.5,2969.875,1217.5,2973.875,1227.5,2977.875,1223.5,2973.875" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1221.5" x2="1663.5" y1="2973.875" y2="2973.875"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="29" x="1233.5" y="2968.8091">data</text><line style="stroke:#000000;stroke-width:1.0;" x1="1216.5" x2="1258.5" y1="3018.1406" y2="3018.1406"/><line style="stroke:#000000;stroke-width:1.0;" x1="1258.5" x2="1258.5" y1="3018.1406" y2="3031.1406"/><line style="stroke:#000000;stroke-width:1.0;" x1="1217.5" x2="1258.5" y1="3031.1406" y2="3031.1406"/><polygon fill="#000000" points="1227.5,3027.1406,1217.5,3031.1406,1227.5,3035.1406,1223.5,3031.1406" style="stroke:#000000;stroke-width:1.0;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="123" x="1223.5" y="2997.9419">render_chart_png()</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="107" x="1223.5" y="3013.0747">(matplotlib, Agg)</text><polygon fill="#000000" points="556,3056.2734,546,3060.2734,556,3064.2734,552,3060.2734" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="550" x2="1215.5" y1="3060.2734" y2="3060.2734"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="114" x="562" y="3055.2075">stats + png bytes</text><polygon fill="#000000" points="249,3085.4063,239,3089.4063,249,3093.4063,245,3089.4063" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="243" x2="544" y1="3089.4063" y2="3089.4063"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="118" x="255" y="3084.3403">send_photo(chart)</text><polygon fill="#000000" points="249,3114.5391,239,3118.5391,249,3122.5391,245,3118.5391" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="243" x2="544" y1="3118.5391" y2="3118.5391"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="163" x="255" y="3113.4731">show progress(stats text)</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="178.5" x2="1692.5" y1="3127.5391" y2="3127.5391"/><text fill="#000000" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="111" x="183.5" y="3137.7495">[Charts disabled]</text><polygon fill="#000000" points="1204.5,3158.4766,1214.5,3162.4766,1204.5,3166.4766,1208.5,3162.4766" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="545" x2="1210.5" y1="3162.4766" y2="3162.4766"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="146" x="552" y="3157.4106">build_text_report(user)</text><polygon fill="#000000" points="1652.5,3187.6094,1662.5,3191.6094,1652.5,3195.6094,1656.5,3191.6094" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1216.5" x2="1658.5" y1="3191.6094" y2="3191.6094"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="118" x="1223.5" y="3186.5435">load minimal stats</text><polygon fill="#000000" points="1227.5,3216.7422,1217.5,3220.7422,1227.5,3224.7422,1223.5,3220.7422" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1221.5" x2="1663.5" y1="3220.7422" y2="3220.7422"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="29" x="1233.5" y="3215.6763">data</text><polygon fill="#000000" points="556,3245.875,546,3249.875,556,3253.875,552,3249.875" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="550" x2="1215.5" y1="3249.875" y2="3249.875"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="61" x="562" y="3244.8091">text stats</text><polygon fill="#000000" points="249,3275.0078,239,3279.0078,249,3283.0078,245,3279.0078" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="243" x2="544" y1="3279.0078" y2="3279.0078"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="163" x="255" y="3273.9419">show progress(text stats)</text><polygon fill="#000000" points="65,3311.1406,55,3315.1406,65,3319.1406,61,3315.1406" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="59" x2="237" y1="3315.1406" y2="3315.1406"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="99" x="71" y="3310.0747">progress report</text><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1.0;" width="1813.5" x="5" y="3343.707"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1818.5" y1="3343.707" y2="3343.707"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1818.5" y1="3346.707" y2="3346.707"/><rect fill="#FFFFFF" height="23.1328" style="stroke:#000000;stroke-width:1.0;" width="83" x="870.25" y="3333.1406"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="64" x="876.25" y="3349.2075">AI Coach</text><path d="M25,3373.2734 L89,3373.2734 L89,3380.4063 L79,3390.4063 L25,3390.4063 L25,3373.2734 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="627.7266" style="stroke:#000000;stroke-width:1.0;" width="1783.5" x="25" y="3373.2734"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="40" y="3386.3403">alt</text><text fill="#000000" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="86" x="104" y="3385.4839">[AI_ENABLED]</text><polygon fill="#000000" points="226,3407.5391,236,3411.5391,226,3415.5391,230,3411.5391" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="54" x2="232" y1="3411.5391" y2="3411.5391"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="56" x="61" y="3406.4731">AI Coach</text><polygon fill="#000000" points="533,3436.6719,543,3440.6719,533,3444.6719,537,3440.6719" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="238" x2="539" y1="3440.6719" y2="3440.6719"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="80" x="245" y="3435.606">cb(ai_menu)</text><path d="M382,3453.6719 L382,3493.6719 L707,3493.6719 L707,3463.6719 L697,3453.6719 L382,3453.6719 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><path d="M697,3453.6719 L697,3463.6719 L707,3463.6719 L697,3453.6719 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="187" x="388" y="3470.7388">If SUBSCRIPTIONS_ENABLED,</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="304" x="388" y="3485.8716">AI sections may be gated by active subscription</text><polygon fill="#000000" points="249,3516.0703,239,3520.0703,249,3524.0703,245,3520.0703" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="243" x2="544" y1="3520.0703" y2="3520.0703"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="148" x="255" y="3515.0044">show ai_menu(options)</text><polygon fill="#000000" points="65,3545.2031,55,3549.2031,65,3553.2031,61,3549.2031" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="59" x2="237" y1="3549.2031" y2="3549.2031"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="37" x="71" y="3544.1372">menu</text><polygon fill="#000000" points="226,3574.3359,236,3578.3359,226,3582.3359,230,3578.3359" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="54" x2="232" y1="3578.3359" y2="3578.3359"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="103" x="61" y="3573.27">Задать вопрос</text><polygon fill="#000000" points="533,3603.4688,543,3607.4688,533,3611.4688,537,3607.4688" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="238" x2="539" y1="3607.4688" y2="3607.4688"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="65" x="245" y="3602.4028">cb(ask_ai)</text><polygon fill="#000000" points="249,3647.7344,239,3651.7344,249,3655.7344,245,3651.7344" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="243" x2="544" y1="3651.7344" y2="3651.7344"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="145" x="255" y="3631.5356">show question_prompt</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="165" x="255" y="3646.6685">(FSM waiting_ai_question)</text><polygon fill="#000000" points="65,3676.8672,55,3680.8672,65,3684.8672,61,3680.8672" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="59" x2="237" y1="3680.8672" y2="3680.8672"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="47" x="71" y="3675.8013">prompt</text><polygon fill="#000000" points="226,3706,236,3710,226,3714,230,3710" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="54" x2="232" y1="3710" y2="3710"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="84" x="61" y="3704.9341">question text</text><polygon fill="#000000" points="533,3735.1328,543,3739.1328,533,3743.1328,537,3739.1328" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="238" x2="539" y1="3739.1328" y2="3739.1328"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="93" x="245" y="3734.0669">msg(question)</text><polygon fill="#000000" points="1357.5,3764.2656,1367.5,3768.2656,1357.5,3772.2656,1361.5,3768.2656" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="545" x2="1363.5" y1="3768.2656" y2="3768.2656"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="208" x="552" y="3763.1997">answer_question(user, question)</text><polygon fill="#000000" points="1652.5,3793.3984,1662.5,3797.3984,1652.5,3801.3984,1656.5,3797.3984" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1369.5" x2="1658.5" y1="3797.3984" y2="3797.3984"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="271" x="1376.5" y="3792.3325">load context(profile + workouts + metrics)</text><polygon fill="#000000" points="1380.5,3822.5313,1370.5,3826.5313,1380.5,3830.5313,1376.5,3826.5313" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1374.5" x2="1663.5" y1="3826.5313" y2="3826.5313"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="48" x="1386.5" y="3821.4653">context</text><polygon fill="#000000" points="1733.5,3851.6641,1743.5,3855.6641,1733.5,3859.6641,1737.5,3855.6641" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1369.5" x2="1739.5" y1="3855.6641" y2="3855.6641"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="154" x="1376.5" y="3850.5981">ask(question + context)</text><polygon fill="#000000" points="1380.5,3880.7969,1370.5,3884.7969,1380.5,3888.7969,1376.5,3884.7969" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1374.5" x2="1744.5" y1="3884.7969" y2="3884.7969"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="45" x="1386.5" y="3879.731">answer</text><polygon fill="#000000" points="556,3909.9297,546,3913.9297,556,3917.9297,552,3913.9297" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="550" x2="1368.5" y1="3913.9297" y2="3913.9297"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="45" x="562" y="3908.8638">answer</text><polygon fill="#000000" points="249,3939.0625,239,3943.0625,249,3947.0625,245,3943.0625" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="243" x2="544" y1="3943.0625" y2="3943.0625"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="168" x="255" y="3937.9966">show ai_response(answer)</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="25" x2="1808.5" y1="3952.0625" y2="3952.0625"/><text fill="#000000" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="81" x="30" y="3962.2729">[AI disabled]</text><path d="M432,3970.8672 L432,3995.8672 L657,3995.8672 L657,3980.8672 L647,3970.8672 L432,3970.8672 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><path d="M647,3970.8672 L647,3980.8672 L657,3980.8672 L647,3970.8672 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="204" x="438" y="3987.9341">Hide AI menu / show info screen</text><!--MD5=[c1779cc0288d00d03d186c2ca6aeb20a]
@startuml
!theme plain
title Telegram Fitness Bot - Monetization & Engagement — Sequence (Charts + AI Coach)

actor User
participant TG as "Telegram"
participant H  as "Handlers"
participant WS as "WalletService"
participant SS as "SubscriptionService"
participant PS as "ProgramService"
participant PR as "ProgressService"
participant AIc as "AICoachService"
database DB
participant AI as "AI Provider"

== Wallet ==
User -> TG: Баланс
TG -> H: cb(wallet_screen)
H  -> WS: get_or_create_wallet(user)
WS -> DB: wallet upsert/select
DB - -> WS: wallet
WS - -> H: wallet
H  - -> TG: show wallet(balance, actions)
TG - -> User: wallet

== Top-up (Telegram Payments) ==
alt PAYMENTS_ENABLED
  User -> TG: Пополнить
  TG -> H: cb(topup)
  H  -> WS: create_invoice(package)
  WS - -> H: invoice payload
  H  -> TG: send_invoice(payload)
  TG - -> User: payment UI

  TG -> H: pre_checkout_query
  H  - -> TG: answer_pre_checkout(ok)

  TG -> H: successful_payment(payload)
  H  -> WS: apply_topup(payload)
  WS -> DB: insert tx(type=topup)\n+ update wallet coins
  DB - -> WS: ok
  WS - -> H: ok
  H  - -> TG: refresh wallet_screen(updated balance)
else Payments disabled
  note over H: show info / hide topup buttons
end

== Subscription (coins) ==
User -> TG: Подписка
TG -> H: cb(subscription_screen)
H  -> SS: get_status(user)
SS -> DB: select subscription
DB - -> SS: active/none
SS - -> H: status
H  -> WS: get_wallet(user)
WS -> DB: select wallet
DB - -> WS: wallet
WS - -> H: wallet
H  - -> TG: show subscription(status, buy/cancel)
TG - -> User: subscription

User -> TG: Купить
TG -> H: cb(buy_subscription)
H  -> SS: purchase_for_coins(user)
SS -> DB: lock/select wallet
DB - -> SS: wallet
alt Not enough coins
  SS - -> H: error("Недостаточно монет")
  H  - -> TG: show wallet_topup_hint
  TG - -> User: hint
else Enough coins
  SS -> DB: insert spend tx\n+ update wallet\n+ upsert subscription(active_until)
  DB - -> SS: ok
  SS - -> H: ok
  H  - -> TG: refresh subscription_screen(updated status)
end

== Programs ==
note over PS: Program data is seeded from YAML at startup
User -> TG: Программы
TG -> H: cb(programs_screen)
H  -> PS: list_programs(user)
PS -> DB: select programs + ownership/prices
DB - -> PS: list
PS - -> H: list
H  - -> TG: show programs_list(catalog)
TG - -> User: catalog

User -> TG: Купить / Активировать
TG -> H: cb(program_action, program_id)

alt action == buy (coins)
  H  -> PS: buy_program_for_coins(user, program_id)
  PS -> DB: select wallet
  DB - -> PS: wallet
  alt Not enough coins
    PS - -> H: error("Недостаточно монет")
    H  - -> TG: show wallet_topup_hint
    TG - -> User: hint
  else Enough coins
    PS -> DB: insert spend tx\n+ update wallet\n+ mark program owned
    DB - -> PS: ok
    PS - -> H: purchased
    H  - -> TG: refresh programs_list(updated catalog)
  end
else action == activate
  H  -> PS: activate_program(user, program_id)
  PS -> DB: set previous active=false\n+ set new active=true\n+ set current_week/day_key
  DB - -> PS: ok
  PS - -> H: activated
  H  - -> TG: show success("Программа активирована")
  TG - -> User: success
end

== Progress / Charts ==
User -> TG: Прогресс
TG -> H: cb(progress_screen)

alt CHARTS_ENABLED
  H  -> PR: build_progress_report(user)
  PR -> DB: load workouts/sets/weight logs
  DB - -> PR: data
  PR -> PR: render_chart_png()\n(matplotlib, Agg)
  PR - -> H: stats + png bytes
  H  -> TG: send_photo(chart)
  H  - -> TG: show progress(stats text)
else Charts disabled
  H  -> PR: build_text_report(user)
  PR -> DB: load minimal stats
  DB - -> PR: data
  PR - -> H: text stats
  H  - -> TG: show progress(text stats)
end
TG - -> User: progress report

== AI Coach ==
alt AI_ENABLED
  User -> TG: AI Coach
  TG -> H: cb(ai_menu)
  note over H: If SUBSCRIPTIONS_ENABLED,\nAI sections may be gated by active subscription
  H  - -> TG: show ai_menu(options)
  TG - -> User: menu

  User -> TG: Задать вопрос
  TG -> H: cb(ask_ai)
  H  - -> TG: show question_prompt\n(FSM waiting_ai_question)
  TG - -> User: prompt

  User -> TG: question text
  TG -> H: msg(question)
  H  -> AIc: answer_question(user, question)
  AIc -> DB: load context(profile + workouts + metrics)
  DB - -> AIc: context
  AIc -> AI: ask(question + context)
  AI - -> AIc: answer
  AIc - -> H: answer
  H  - -> TG: show ai_response(answer)
else AI disabled
  note over H: Hide AI menu / show info screen
end
@enduml

@startuml







<style>
  root {
    BackgroundColor white
    FontColor black
    FontName Verdana
    HyperLinkColor blue
    LineColor black
    LineThickness 1
    Margin 5
  }
  caption {
    LineThickness 0
  }
  footer {
    LineThickness 0
  }
  header {
    LineThickness 0
  }
  node {
    MaximumWidth 300
  }
  title {
    FontSize 22
    LineThickness 0
  }
</style>

skinparam ArrowLollipopColor black
skinparam BackgroundColor white
skinparam DefaultFontName Verdana
skinparam DefaultMonospacedFontName Courier
skinparam LifelineStrategy nosolid
skinparam ParticipantPadding 10
skinparam SequenceLifeLineBorderColor black
skinparam Shadowing false
skinparam UseBetaStyle true

skinparam Activity {
  BackgroundColor white
  BarColor black
  BorderColor black
  FontColor black
  FontName Verdana
}
skinparam Boundary {
  FontColor black
}
skinparam Box {
  Padding 5
}
skinparam CircledCharacter {
  FontColor black
  FontName Courier
  Radius 9
}
skinparam Class {
  BackgroundColor white
  BorderColor black
  FontColor black
  FontName Verdana
}
skinparam ClassAttribute {
  FontColor black
  FontName Verdana
}
skinparam ClassStereotype {
  FontColor black
  FontName Verdana
}
skinparam Footer {
  FontColor black
  FontName Verdana
}
skinparam Header {
  FontColor black
  FontName Verdana
}
skinparam Hyperlink {
  Color blue
}
skinparam IconPackage {
  Color black
  BackgroundColor white
}
skinparam IconPrivate {
  Color black
  BackgroundColor white
}
skinparam IconProtected {
  Color black
  BackgroundColor white
}
skinparam IconPublic {
  Color black
  BackgroundColor white
}
skinparam Note {
  FontColor black
  FontName Verdana
}
skinparam Object {
  BorderColor black
}
skinparam Package {
  BorderColor black
  FontColor black
  FontName Verdana
}
skinparam State {
  BackgroundColor white
  BorderColor black
}
skinparam StereotypeA {
  BackgroundColor white
  BorderColor black
}
skinparam StereotypeC {
  BackgroundColor white
  BorderColor black
}
skinparam StereotypeE {
  BackgroundColor white
  BorderColor black
}
skinparam StereotypeI {
  BackgroundColor white
  BorderColor black
}
skinparam StereotypeN {
  BackgroundColor white
  BorderColor black
}
skinparam UseCaseStereoType {
  FontColor black
  FontName Verdana
}
title Telegram Fitness Bot - Monetization & Engagement — Sequence (Charts + AI Coach)

actor User
participant TG as "Telegram"
participant H  as "Handlers"
participant WS as "WalletService"
participant SS as "SubscriptionService"
participant PS as "ProgramService"
participant PR as "ProgressService"
participant AIc as "AICoachService"
database DB
participant AI as "AI Provider"

== Wallet ==
User -> TG: Баланс
TG -> H: cb(wallet_screen)
H  -> WS: get_or_create_wallet(user)
WS -> DB: wallet upsert/select
DB - -> WS: wallet
WS - -> H: wallet
H  - -> TG: show wallet(balance, actions)
TG - -> User: wallet

== Top-up (Telegram Payments) ==
alt PAYMENTS_ENABLED
  User -> TG: Пополнить
  TG -> H: cb(topup)
  H  -> WS: create_invoice(package)
  WS - -> H: invoice payload
  H  -> TG: send_invoice(payload)
  TG - -> User: payment UI

  TG -> H: pre_checkout_query
  H  - -> TG: answer_pre_checkout(ok)

  TG -> H: successful_payment(payload)
  H  -> WS: apply_topup(payload)
  WS -> DB: insert tx(type=topup)\n+ update wallet coins
  DB - -> WS: ok
  WS - -> H: ok
  H  - -> TG: refresh wallet_screen(updated balance)
else Payments disabled
  note over H: show info / hide topup buttons
end

== Subscription (coins) ==
User -> TG: Подписка
TG -> H: cb(subscription_screen)
H  -> SS: get_status(user)
SS -> DB: select subscription
DB - -> SS: active/none
SS - -> H: status
H  -> WS: get_wallet(user)
WS -> DB: select wallet
DB - -> WS: wallet
WS - -> H: wallet
H  - -> TG: show subscription(status, buy/cancel)
TG - -> User: subscription

User -> TG: Купить
TG -> H: cb(buy_subscription)
H  -> SS: purchase_for_coins(user)
SS -> DB: lock/select wallet
DB - -> SS: wallet
alt Not enough coins
  SS - -> H: error("Недостаточно монет")
  H  - -> TG: show wallet_topup_hint
  TG - -> User: hint
else Enough coins
  SS -> DB: insert spend tx\n+ update wallet\n+ upsert subscription(active_until)
  DB - -> SS: ok
  SS - -> H: ok
  H  - -> TG: refresh subscription_screen(updated status)
end

== Programs ==
note over PS: Program data is seeded from YAML at startup
User -> TG: Программы
TG -> H: cb(programs_screen)
H  -> PS: list_programs(user)
PS -> DB: select programs + ownership/prices
DB - -> PS: list
PS - -> H: list
H  - -> TG: show programs_list(catalog)
TG - -> User: catalog

User -> TG: Купить / Активировать
TG -> H: cb(program_action, program_id)

alt action == buy (coins)
  H  -> PS: buy_program_for_coins(user, program_id)
  PS -> DB: select wallet
  DB - -> PS: wallet
  alt Not enough coins
    PS - -> H: error("Недостаточно монет")
    H  - -> TG: show wallet_topup_hint
    TG - -> User: hint
  else Enough coins
    PS -> DB: insert spend tx\n+ update wallet\n+ mark program owned
    DB - -> PS: ok
    PS - -> H: purchased
    H  - -> TG: refresh programs_list(updated catalog)
  end
else action == activate
  H  -> PS: activate_program(user, program_id)
  PS -> DB: set previous active=false\n+ set new active=true\n+ set current_week/day_key
  DB - -> PS: ok
  PS - -> H: activated
  H  - -> TG: show success("Программа активирована")
  TG - -> User: success
end

== Progress / Charts ==
User -> TG: Прогресс
TG -> H: cb(progress_screen)

alt CHARTS_ENABLED
  H  -> PR: build_progress_report(user)
  PR -> DB: load workouts/sets/weight logs
  DB - -> PR: data
  PR -> PR: render_chart_png()\n(matplotlib, Agg)
  PR - -> H: stats + png bytes
  H  -> TG: send_photo(chart)
  H  - -> TG: show progress(stats text)
else Charts disabled
  H  -> PR: build_text_report(user)
  PR -> DB: load minimal stats
  DB - -> PR: data
  PR - -> H: text stats
  H  - -> TG: show progress(text stats)
end
TG - -> User: progress report

== AI Coach ==
alt AI_ENABLED
  User -> TG: AI Coach
  TG -> H: cb(ai_menu)
  note over H: If SUBSCRIPTIONS_ENABLED,\nAI sections may be gated by active subscription
  H  - -> TG: show ai_menu(options)
  TG - -> User: menu

  User -> TG: Задать вопрос
  TG -> H: cb(ask_ai)
  H  - -> TG: show question_prompt\n(FSM waiting_ai_question)
  TG - -> User: prompt

  User -> TG: question text
  TG -> H: msg(question)
  H  -> AIc: answer_question(user, question)
  AIc -> DB: load context(profile + workouts + metrics)
  DB - -> AIc: context
  AIc -> AI: ask(question + context)
  AI - -> AIc: answer
  AIc - -> H: answer
  H  - -> TG: show ai_response(answer)
else AI disabled
  note over H: Hide AI menu / show info screen
end
@enduml

PlantUML version 1.2022.7(Mon Aug 22 17:01:30 UTC 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: null
--></g></svg>
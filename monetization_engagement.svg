<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="4390px" preserveAspectRatio="none" style="width:1967px;height:4390px;background:#FFFFFF;" version="1.1" viewBox="0 0 1967 4390" width="1967px" zoomAndPan="magnify"><defs/><g><rect fill="#FFFFFF" height="35.6094" id="_title" style="stroke:#FFFFFF;stroke-width:0.0;" width="1187" x="388.5" y="10"/><text fill="#000000" font-family="Verdana" font-size="22" font-weight="bold" lengthAdjust="spacing" textLength="1177" x="393.5" y="35.4209">Telegram Fitness Bot - Monetization &amp; Engagement — Sequence Diagram (Charts + AI Coach)</text><rect fill="#FFFFFF" height="519.1953" style="stroke:#000000;stroke-width:1.0;" width="1819" x="15" y="494.3672"/><rect fill="#FFFFFF" height="49.9375" style="stroke:none;stroke-width:1.0;" width="1819" x="15" y="963.625"/><rect fill="#FFFFFF" height="295.2656" style="stroke:#000000;stroke-width:1.0;" width="1645.5" x="188.5" y="1595.0859"/><rect fill="#FFFFFF" height="190.7344" style="stroke:none;stroke-width:1.0;" width="1645.5" x="188.5" y="1699.6172"/><rect fill="#FFFFFF" height="633.6641" style="stroke:#000000;stroke-width:1.0;" width="1665.5" x="178.5" y="2303.0781"/><rect fill="#FFFFFF" height="295.2656" style="stroke:#000000;stroke-width:1.0;" width="1645.5" x="188.5" y="2414.6094"/><rect fill="#FFFFFF" height="190.7344" style="stroke:none;stroke-width:1.0;" width="1645.5" x="188.5" y="2519.1406"/><rect fill="#FFFFFF" height="219.8672" style="stroke:none;stroke-width:1.0;" width="1665.5" x="178.5" y="2716.875"/><rect fill="#FFFFFF" height="438.7969" style="stroke:#000000;stroke-width:1.0;" width="1645.5" x="188.5" y="3052.1406"/><rect fill="#FFFFFF" height="160.4688" style="stroke:none;stroke-width:1.0;" width="1645.5" x="188.5" y="3330.4688"/><rect fill="#FFFFFF" height="715.125" style="stroke:#000000;stroke-width:1.0;" width="1935" x="15" y="3577.2031"/><rect fill="#FFFFFF" height="49.9375" style="stroke:none;stroke-width:1.0;" width="1935" x="15" y="4242.3906"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="44" x2="44" y1="128.9063" y2="4309.3281"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="247.5" x2="247.5" y1="128.9063" y2="4309.3281"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="516.5" x2="516.5" y1="128.9063" y2="4309.3281"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="722.5" x2="722.5" y1="128.9063" y2="4309.3281"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="866.5" x2="866.5" y1="128.9063" y2="4309.3281"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1024.5" x2="1024.5" y1="128.9063" y2="4309.3281"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1190.5" x2="1190.5" y1="128.9063" y2="4309.3281"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1344.5" x2="1344.5" y1="128.9063" y2="4309.3281"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1497.5" x2="1497.5" y1="128.9063" y2="4309.3281"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1796" x2="1796" y1="128.9063" y2="4309.3281"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1887" x2="1887" y1="128.9063" y2="4309.3281"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="32" x="25" y="125.6045">User</text><ellipse cx="44" cy="60.6094" fill="#FFFFFF" rx="8" ry="8" style="stroke:#000000;stroke-width:1.0;"/><path d="M44,68.6094 L44,95.6094 M31,76.6094 L57,76.6094 M44,95.6094 L31,110.6094 M44,95.6094 L57,110.6094 " fill="none" style="stroke:#000000;stroke-width:1.0;"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="32" x="25" y="4321.3232">User</text><ellipse cx="44" cy="4333.625" fill="#FFFFFF" rx="8" ry="8" style="stroke:#000000;stroke-width:1.0;"/><path d="M44,4341.625 L44,4368.625 M31,4349.625 L57,4349.625 M44,4368.625 L31,4383.625 M44,4368.625 L57,4383.625 " fill="none" style="stroke:#000000;stroke-width:1.0;"/><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="79" x="208.5" y="97.6094"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="65" x="215.5" y="117.6045">Telegram</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="79" x="208.5" y="4308.3281"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="65" x="215.5" y="4328.3232">Telegram</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="75" x="479.5" y="97.6094"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="61" x="486.5" y="117.6045">Handlers</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="75" x="479.5" y="4308.3281"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="61" x="486.5" y="4328.3232">Handlers</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="123" x="661.5" y="97.6094"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="109" x="668.5" y="117.6045">ScreenManager</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="123" x="661.5" y="4308.3281"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="109" x="668.5" y="4328.3232">ScreenManager</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="105" x="814.5" y="97.6094"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="91" x="821.5" y="117.6045">WalletService</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="105" x="814.5" y="4308.3281"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="91" x="821.5" y="4328.3232">WalletService</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="150" x="949.5" y="97.6094"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="136" x="956.5" y="117.6045">SubscriptionService</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="150" x="949.5" y="4308.3281"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="136" x="956.5" y="4328.3232">SubscriptionService</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="122" x="1129.5" y="97.6094"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="108" x="1136.5" y="117.6045">ProgramService</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="122" x="1129.5" y="4308.3281"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="108" x="1136.5" y="4328.3232">ProgramService</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="126" x="1281.5" y="97.6094"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="112" x="1288.5" y="117.6045">ProgressService</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="126" x="1281.5" y="4308.3281"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="112" x="1288.5" y="4328.3232">ProgressService</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="120" x="1437.5" y="97.6094"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="106" x="1444.5" y="117.6045">AICoachService</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="120" x="1437.5" y="4308.3281"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="106" x="1444.5" y="4328.3232">AICoachService</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="35" x="1779" y="97.6094"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="21" x="1786" y="117.6045">DB</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="35" x="1779" y="4308.3281"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="21" x="1786" y="4328.3232">DB</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="86" x="1844" y="97.6094"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="72" x="1851" y="117.6045">AI Provider</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="86" x="1844" y="4308.3281"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="72" x="1851" y="4328.3232">AI Provider</text><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1.0;" width="1955" x="5" y="159.4727"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1960" y1="159.4727" y2="159.4727"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1960" y1="162.4727" y2="162.4727"/><rect fill="#FFFFFF" height="23.1328" style="stroke:#000000;stroke-width:1.0;" width="65" x="950" y="148.9063"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="46" x="956" y="164.9731">Wallet</text><polygon fill="#000000" points="236,199.1719,246,203.1719,236,207.1719,240,203.1719" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="44" x2="242" y1="203.1719" y2="203.1719"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="58" x="51" y="198.106">"Баланс"</text><polygon fill="#000000" points="505,228.3047,515,232.3047,505,236.3047,509,232.3047" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="248" x2="511" y1="232.3047" y2="232.3047"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="149" x="255" y="227.2388">Callback(wallet_screen)</text><polygon fill="#000000" points="855,257.4375,865,261.4375,855,265.4375,859,261.4375" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="517" x2="861" y1="261.4375" y2="261.4375"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="170" x="524" y="256.3716">get_or_create_wallet(user)</text><polygon fill="#000000" points="1784.5,286.5703,1794.5,290.5703,1784.5,294.5703,1788.5,290.5703" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="867" x2="1790.5" y1="290.5703" y2="290.5703"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="123" x="874" y="285.5044">wallet upsert/select</text><polygon fill="#000000" points="878,315.7031,868,319.7031,878,323.7031,874,319.7031" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="872" x2="1795.5" y1="319.7031" y2="319.7031"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="36" x="884" y="314.6372">wallet</text><polygon fill="#000000" points="528,344.8359,518,348.8359,528,352.8359,524,348.8359" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="522" x2="866" y1="348.8359" y2="348.8359"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="36" x="534" y="343.77">wallet</text><polygon fill="#000000" points="711,373.9688,721,377.9688,711,381.9688,715,377.9688" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="517" x2="717" y1="377.9688" y2="377.9688"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="128" x="524" y="372.9028">show(wallet_screen)</text><polygon fill="#000000" points="259,403.1016,249,407.1016,259,411.1016,255,407.1016" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="253" x2="722" y1="407.1016" y2="407.1016"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="115" x="265" y="402.0356">balance + actions</text><polygon fill="#000000" points="55,432.2344,45,436.2344,55,440.2344,51,436.2344" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="49" x2="247" y1="436.2344" y2="436.2344"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="36" x="61" y="431.1685">wallet</text><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1.0;" width="1955" x="5" y="464.8008"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1960" y1="464.8008" y2="464.8008"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1960" y1="467.8008" y2="467.8008"/><rect fill="#FFFFFF" height="23.1328" style="stroke:#000000;stroke-width:1.0;" width="340" x="812.5" y="454.2344"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="321" x="818.5" y="470.3013">Top-up via Telegram Payments (if enabled)</text><path d="M15,494.3672 L79,494.3672 L79,501.5 L69,511.5 L15,511.5 L15,494.3672 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="519.1953" style="stroke:#000000;stroke-width:1.0;" width="1819" x="15" y="494.3672"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="30" y="507.4341">alt</text><text fill="#000000" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="232" x="94" y="506.5776">[PAYMENTS_ENABLED (feature flag)]</text><polygon fill="#000000" points="236,528.6328,246,532.6328,236,536.6328,240,532.6328" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="44" x2="242" y1="532.6328" y2="532.6328"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="84" x="51" y="527.5669">"Пополнить"</text><polygon fill="#000000" points="505,557.7656,515,561.7656,505,565.7656,509,561.7656" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="248" x2="511" y1="561.7656" y2="561.7656"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="100" x="255" y="556.6997">Callback(topup)</text><polygon fill="#000000" points="855,586.8984,865,590.8984,855,594.8984,859,590.8984" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="517" x2="861" y1="590.8984" y2="590.8984"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="156" x="524" y="585.8325">create_invoice(package)</text><polygon fill="#000000" points="528,616.0313,518,620.0313,528,624.0313,524,620.0313" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="522" x2="866" y1="620.0313" y2="620.0313"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="98" x="534" y="614.9653">invoice payload</text><polygon fill="#000000" points="259,645.1641,249,649.1641,259,653.1641,255,649.1641" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="253" x2="516" y1="649.1641" y2="649.1641"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="142" x="265" y="644.0981">send_invoice(payload)</text><polygon fill="#000000" points="55,674.2969,45,678.2969,55,682.2969,51,678.2969" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="49" x2="247" y1="678.2969" y2="678.2969"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="74" x="61" y="673.231">payment UI</text><polygon fill="#000000" points="505,703.4297,515,707.4297,505,711.4297,509,707.4297" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="248" x2="511" y1="707.4297" y2="707.4297"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="129" x="255" y="702.3638">pre_checkout_query</text><polygon fill="#000000" points="259,732.5625,249,736.5625,259,740.5625,255,736.5625" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="253" x2="516" y1="736.5625" y2="736.5625"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="163" x="265" y="731.4966">answer_pre_checkout(ok)</text><polygon fill="#000000" points="505,761.6953,515,765.6953,505,769.6953,509,765.6953" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="248" x2="511" y1="765.6953" y2="765.6953"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="190" x="255" y="760.6294">successful_payment(payload)</text><polygon fill="#000000" points="855,790.8281,865,794.8281,855,798.8281,859,794.8281" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="517" x2="861" y1="794.8281" y2="794.8281"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="138" x="524" y="789.7622">apply_topup(payload)</text><polygon fill="#000000" points="1784.5,835.0938,1794.5,839.0938,1784.5,843.0938,1788.5,839.0938" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="867" x2="1790.5" y1="839.0938" y2="839.0938"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="211" x="874" y="818.895">insert_transaction(type="topup")</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="137" x="874" y="834.0278">+ update wallet coins</text><polygon fill="#000000" points="878,864.2266,868,868.2266,878,872.2266,874,868.2266" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="872" x2="1795.5" y1="868.2266" y2="868.2266"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="15" x="884" y="863.1606">ok</text><polygon fill="#000000" points="528,893.3594,518,897.3594,528,901.3594,524,897.3594" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="522" x2="866" y1="897.3594" y2="897.3594"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="15" x="534" y="892.2935">ok</text><polygon fill="#000000" points="711,922.4922,721,926.4922,711,930.4922,715,926.4922" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="517" x2="717" y1="926.4922" y2="926.4922"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="141" x="524" y="921.4263">refresh(wallet_screen)</text><polygon fill="#000000" points="259,951.625,249,955.625,259,959.625,255,955.625" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="253" x2="722" y1="955.625" y2="955.625"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="107" x="265" y="950.5591">updated balance</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="15" x2="1834" y1="964.625" y2="964.625"/><text fill="#000000" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="131" x="20" y="974.8354">[Payments disabled]</text><path d="M410,983.4297 L410,1008.4297 L623,1008.4297 L623,993.4297 L613,983.4297 L410,983.4297 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><path d="M613,983.4297 L613,993.4297 L623,993.4297 L613,983.4297 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="192" x="416" y="1000.4966">show info / hide topup buttons</text><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1.0;" width="1955" x="5" y="1041.1289"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1960" y1="1041.1289" y2="1041.1289"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1960" y1="1044.1289" y2="1044.1289"/><rect fill="#FFFFFF" height="23.1328" style="stroke:#000000;stroke-width:1.0;" width="227" x="869" y="1030.5625"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="208" x="875" y="1046.6294">Subscription (paid by coins)</text><polygon fill="#000000" points="236,1080.8281,246,1084.8281,236,1088.8281,240,1084.8281" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="44" x2="242" y1="1084.8281" y2="1084.8281"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="76" x="51" y="1079.7622">"Подписка"</text><polygon fill="#000000" points="505,1109.9609,515,1113.9609,505,1117.9609,509,1113.9609" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="248" x2="511" y1="1113.9609" y2="1113.9609"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="190" x="255" y="1108.895">Callback(subscription_screen)</text><polygon fill="#000000" points="1012.5,1139.0938,1022.5,1143.0938,1012.5,1147.0938,1016.5,1143.0938" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="517" x2="1018.5" y1="1143.0938" y2="1143.0938"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="106" x="524" y="1138.0278">get_status(user)</text><polygon fill="#000000" points="1784.5,1168.2266,1794.5,1172.2266,1784.5,1176.2266,1788.5,1172.2266" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1024.5" x2="1790.5" y1="1172.2266" y2="1172.2266"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="119" x="1031.5" y="1167.1606">select subscription</text><polygon fill="#000000" points="1035.5,1197.3594,1025.5,1201.3594,1035.5,1205.3594,1031.5,1201.3594" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1029.5" x2="1795.5" y1="1201.3594" y2="1201.3594"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="74" x="1041.5" y="1196.2935">active/none</text><polygon fill="#000000" points="528,1226.4922,518,1230.4922,528,1234.4922,524,1230.4922" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="522" x2="1023.5" y1="1230.4922" y2="1230.4922"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="40" x="534" y="1225.4263">status</text><polygon fill="#000000" points="855,1255.625,865,1259.625,855,1263.625,859,1259.625" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="517" x2="861" y1="1259.625" y2="1259.625"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="102" x="524" y="1254.5591">get_wallet(user)</text><polygon fill="#000000" points="1784.5,1284.7578,1794.5,1288.7578,1784.5,1292.7578,1788.5,1288.7578" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="867" x2="1790.5" y1="1288.7578" y2="1288.7578"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="78" x="874" y="1283.6919">select wallet</text><polygon fill="#000000" points="878,1313.8906,868,1317.8906,878,1321.8906,874,1317.8906" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="872" x2="1795.5" y1="1317.8906" y2="1317.8906"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="36" x="884" y="1312.8247">wallet</text><polygon fill="#000000" points="528,1343.0234,518,1347.0234,528,1351.0234,524,1347.0234" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="522" x2="866" y1="1347.0234" y2="1347.0234"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="36" x="534" y="1341.9575">wallet</text><polygon fill="#000000" points="711,1372.1563,721,1376.1563,711,1380.1563,715,1376.1563" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="517" x2="717" y1="1376.1563" y2="1376.1563"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="169" x="524" y="1371.0903">show(subscription_screen)</text><polygon fill="#000000" points="259,1401.2891,249,1405.2891,259,1409.2891,255,1405.2891" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="253" x2="722" y1="1405.2891" y2="1405.2891"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="127" x="265" y="1400.2231">status + buy/cancel</text><polygon fill="#000000" points="55,1430.4219,45,1434.4219,55,1438.4219,51,1434.4219" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="49" x2="247" y1="1434.4219" y2="1434.4219"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="77" x="61" y="1429.356">subscription</text><polygon fill="#000000" points="236,1459.5547,246,1463.5547,236,1467.5547,240,1463.5547" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="44" x2="242" y1="1463.5547" y2="1463.5547"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="59" x="51" y="1458.4888">"Купить"</text><polygon fill="#000000" points="505,1488.6875,515,1492.6875,505,1496.6875,509,1492.6875" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="248" x2="511" y1="1492.6875" y2="1492.6875"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="170" x="255" y="1487.6216">Callback(buy_subscription)</text><polygon fill="#000000" points="1012.5,1517.8203,1022.5,1521.8203,1012.5,1525.8203,1016.5,1521.8203" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="517" x2="1018.5" y1="1521.8203" y2="1521.8203"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="161" x="524" y="1516.7544">purchase_for_coins(user)</text><polygon fill="#000000" points="1784.5,1546.9531,1794.5,1550.9531,1784.5,1554.9531,1788.5,1550.9531" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1024.5" x2="1790.5" y1="1550.9531" y2="1550.9531"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="107" x="1031.5" y="1545.8872">lock/select wallet</text><polygon fill="#000000" points="1035.5,1576.0859,1025.5,1580.0859,1035.5,1584.0859,1031.5,1580.0859" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1029.5" x2="1795.5" y1="1580.0859" y2="1580.0859"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="36" x="1041.5" y="1575.02">wallet</text><path d="M188.5,1595.0859 L252.5,1595.0859 L252.5,1602.2188 L242.5,1612.2188 L188.5,1612.2188 L188.5,1595.0859 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="295.2656" style="stroke:#000000;stroke-width:1.0;" width="1645.5" x="188.5" y="1595.0859"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="203.5" y="1608.1528">alt</text><text fill="#000000" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="122" x="267.5" y="1607.2964">[Not enough coins]</text><polygon fill="#000000" points="528,1629.3516,518,1633.3516,528,1637.3516,524,1633.3516" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="522" x2="1023.5" y1="1633.3516" y2="1633.3516"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="198" x="534" y="1628.2856">error("Недостаточно монет")</text><polygon fill="#000000" points="711,1658.4844,721,1662.4844,711,1666.4844,715,1662.4844" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="517" x2="717" y1="1662.4844" y2="1662.4844"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="153" x="524" y="1657.4185">show(wallet_topup_hint)</text><polygon fill="#000000" points="259,1687.6172,249,1691.6172,259,1695.6172,255,1691.6172" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="253" x2="722" y1="1691.6172" y2="1691.6172"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="24" x="265" y="1686.5513">hint</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="188.5" x2="1834" y1="1700.6172" y2="1700.6172"/><text fill="#000000" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="96" x="193.5" y="1710.8276">[Enough coins]</text><polygon fill="#000000" points="1784.5,1761.8203,1794.5,1765.8203,1784.5,1769.8203,1788.5,1765.8203" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1024.5" x2="1790.5" y1="1765.8203" y2="1765.8203"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="155" x="1031.5" y="1730.4888">insert spend transaction</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="100" x="1031.5" y="1745.6216">+ update wallet</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="219" x="1031.5" y="1760.7544">+ upsert subscription(active_until)</text><polygon fill="#000000" points="1035.5,1790.9531,1025.5,1794.9531,1035.5,1798.9531,1031.5,1794.9531" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1029.5" x2="1795.5" y1="1794.9531" y2="1794.9531"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="15" x="1041.5" y="1789.8872">ok</text><polygon fill="#000000" points="528,1820.0859,518,1824.0859,528,1828.0859,524,1824.0859" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="522" x2="1023.5" y1="1824.0859" y2="1824.0859"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="15" x="534" y="1819.02">ok</text><polygon fill="#000000" points="711,1849.2188,721,1853.2188,711,1857.2188,715,1853.2188" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="517" x2="717" y1="1853.2188" y2="1853.2188"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="182" x="524" y="1848.1528">refresh(subscription_screen)</text><polygon fill="#000000" points="259,1878.3516,249,1882.3516,259,1886.3516,255,1882.3516" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="253" x2="722" y1="1882.3516" y2="1882.3516"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="97" x="265" y="1877.2856">updated status</text><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1.0;" width="1955" x="5" y="1917.918"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1960" y1="1917.918" y2="1917.918"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1960" y1="1920.918" y2="1920.918"/><rect fill="#FFFFFF" height="23.1328" style="stroke:#000000;stroke-width:1.0;" width="279" x="843" y="1907.3516"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="260" x="849" y="1923.4185">Programs (catalog / buy / activate)</text><path d="M1034,1945.4844 L1034,1970.4844 L1347,1970.4844 L1347,1955.4844 L1337,1945.4844 L1034,1945.4844 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><path d="M1337,1945.4844 L1337,1955.4844 L1347,1955.4844 L1337,1945.4844 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="292" x="1040" y="1962.5513">Program data is seeded from YAML at startup</text><polygon fill="#000000" points="236,1992.75,246,1996.75,236,2000.75,240,1996.75" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="44" x2="242" y1="1996.75" y2="1996.75"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="98" x="51" y="1991.6841">"&#55357;&#56523; Программы"</text><polygon fill="#000000" points="505,2021.8828,515,2025.8828,505,2029.8828,509,2025.8828" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="248" x2="511" y1="2025.8828" y2="2025.8828"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="175" x="255" y="2020.8169">Callback(programs_screen)</text><polygon fill="#000000" points="1178.5,2051.0156,1188.5,2055.0156,1178.5,2059.0156,1182.5,2055.0156" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="517" x2="1184.5" y1="2055.0156" y2="2055.0156"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="125" x="524" y="2049.9497">list_programs(user)</text><polygon fill="#000000" points="1784.5,2080.1484,1794.5,2084.1484,1784.5,2088.1484,1788.5,2084.1484" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1190.5" x2="1790.5" y1="2084.1484" y2="2084.1484"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="229" x="1197.5" y="2079.0825">select programs + ownership/prices</text><polygon fill="#000000" points="1201.5,2109.2813,1191.5,2113.2813,1201.5,2117.2813,1197.5,2113.2813" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1195.5" x2="1795.5" y1="2113.2813" y2="2113.2813"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="18" x="1207.5" y="2108.2153">list</text><polygon fill="#000000" points="528,2138.4141,518,2142.4141,528,2146.4141,524,2142.4141" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="522" x2="1189.5" y1="2142.4141" y2="2142.4141"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="18" x="534" y="2137.3481">list</text><polygon fill="#000000" points="711,2167.5469,721,2171.5469,711,2175.5469,715,2171.5469" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="517" x2="717" y1="2171.5469" y2="2171.5469"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="129" x="524" y="2166.481">show(programs_list)</text><polygon fill="#000000" points="259,2196.6797,249,2200.6797,259,2204.6797,255,2200.6797" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="253" x2="722" y1="2200.6797" y2="2200.6797"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="47" x="265" y="2195.6138">catalog</text><polygon fill="#000000" points="55,2225.8125,45,2229.8125,55,2233.8125,51,2229.8125" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="49" x2="247" y1="2229.8125" y2="2229.8125"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="47" x="61" y="2224.7466">catalog</text><polygon fill="#000000" points="236,2254.9453,246,2258.9453,236,2262.9453,240,2258.9453" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="44" x2="242" y1="2258.9453" y2="2258.9453"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="180" x="51" y="2253.8794">"Купить" / "Активировать"</text><polygon fill="#000000" points="505,2284.0781,515,2288.0781,505,2292.0781,509,2288.0781" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="248" x2="511" y1="2288.0781" y2="2288.0781"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="245" x="255" y="2283.0122">Callback(program_action, program_id)</text><path d="M178.5,2303.0781 L242.5,2303.0781 L242.5,2310.2109 L232.5,2320.2109 L178.5,2320.2109 L178.5,2303.0781 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="633.6641" style="stroke:#000000;stroke-width:1.0;" width="1665.5" x="178.5" y="2303.0781"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="193.5" y="2316.145">alt</text><text fill="#000000" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="199" x="257.5" y="2315.2886">[action == buy (price in coins)]</text><polygon fill="#000000" points="1178.5,2337.3438,1188.5,2341.3438,1178.5,2345.3438,1182.5,2341.3438" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="517" x2="1184.5" y1="2341.3438" y2="2341.3438"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="268" x="524" y="2336.2778">buy_program_for_coins(user, program_id)</text><polygon fill="#000000" points="1784.5,2366.4766,1794.5,2370.4766,1784.5,2374.4766,1788.5,2370.4766" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1190.5" x2="1790.5" y1="2370.4766" y2="2370.4766"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="78" x="1197.5" y="2365.4106">select wallet</text><polygon fill="#000000" points="1201.5,2395.6094,1191.5,2399.6094,1201.5,2403.6094,1197.5,2399.6094" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1195.5" x2="1795.5" y1="2399.6094" y2="2399.6094"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="36" x="1207.5" y="2394.5435">wallet</text><path d="M188.5,2414.6094 L252.5,2414.6094 L252.5,2421.7422 L242.5,2431.7422 L188.5,2431.7422 L188.5,2414.6094 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="295.2656" style="stroke:#000000;stroke-width:1.0;" width="1645.5" x="188.5" y="2414.6094"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="203.5" y="2427.6763">alt</text><text fill="#000000" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="122" x="267.5" y="2426.8198">[Not enough coins]</text><polygon fill="#000000" points="528,2448.875,518,2452.875,528,2456.875,524,2452.875" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="522" x2="1189.5" y1="2452.875" y2="2452.875"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="198" x="534" y="2447.8091">error("Недостаточно монет")</text><polygon fill="#000000" points="711,2478.0078,721,2482.0078,711,2486.0078,715,2482.0078" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="517" x2="717" y1="2482.0078" y2="2482.0078"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="153" x="524" y="2476.9419">show(wallet_topup_hint)</text><polygon fill="#000000" points="259,2507.1406,249,2511.1406,259,2515.1406,255,2511.1406" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="253" x2="722" y1="2511.1406" y2="2511.1406"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="24" x="265" y="2506.0747">hint</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="188.5" x2="1834" y1="2520.1406" y2="2520.1406"/><text fill="#000000" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="96" x="193.5" y="2530.3511">[Enough coins]</text><polygon fill="#000000" points="1784.5,2581.3438,1794.5,2585.3438,1784.5,2589.3438,1788.5,2585.3438" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1190.5" x2="1790.5" y1="2585.3438" y2="2585.3438"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="155" x="1197.5" y="2550.0122">insert spend transaction</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="100" x="1197.5" y="2565.145">+ update wallet</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="152" x="1197.5" y="2580.2778">+ mark program owned</text><polygon fill="#000000" points="1201.5,2610.4766,1191.5,2614.4766,1201.5,2618.4766,1197.5,2614.4766" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1195.5" x2="1795.5" y1="2614.4766" y2="2614.4766"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="15" x="1207.5" y="2609.4106">ok</text><polygon fill="#000000" points="528,2639.6094,518,2643.6094,528,2647.6094,524,2643.6094" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="522" x2="1189.5" y1="2643.6094" y2="2643.6094"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="67" x="534" y="2638.5435">purchased</text><polygon fill="#000000" points="711,2668.7422,721,2672.7422,711,2676.7422,715,2672.7422" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="517" x2="717" y1="2672.7422" y2="2672.7422"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="142" x="524" y="2667.6763">refresh(programs_list)</text><polygon fill="#000000" points="259,2697.875,249,2701.875,259,2705.875,255,2701.875" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="253" x2="722" y1="2701.875" y2="2701.875"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="104" x="265" y="2696.8091">updated catalog</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="178.5" x2="1844" y1="2717.875" y2="2717.875"/><text fill="#000000" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="128" x="183.5" y="2728.0854">[action == activate]</text><polygon fill="#000000" points="1178.5,2748.8125,1188.5,2752.8125,1178.5,2756.8125,1182.5,2752.8125" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="517" x2="1184.5" y1="2752.8125" y2="2752.8125"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="232" x="524" y="2747.7466">activate_program(user, program_id)</text><polygon fill="#000000" points="1784.5,2808.2109,1794.5,2812.2109,1784.5,2816.2109,1788.5,2812.2109" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1190.5" x2="1790.5" y1="2812.2109" y2="2812.2109"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="161" x="1197.5" y="2776.8794">set previous active=false</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="143" x="1197.5" y="2792.0122">+ set new active=true</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="180" x="1197.5" y="2807.145">+ set current_week/day_key</text><polygon fill="#000000" points="1201.5,2837.3438,1191.5,2841.3438,1201.5,2845.3438,1197.5,2841.3438" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1195.5" x2="1795.5" y1="2841.3438" y2="2841.3438"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="15" x="1207.5" y="2836.2778">ok</text><polygon fill="#000000" points="528,2866.4766,518,2870.4766,528,2874.4766,524,2870.4766" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="522" x2="1189.5" y1="2870.4766" y2="2870.4766"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="59" x="534" y="2865.4106">activated</text><polygon fill="#000000" points="711,2895.6094,721,2899.6094,711,2903.6094,715,2899.6094" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="517" x2="717" y1="2899.6094" y2="2899.6094"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="143" x="524" y="2894.5435">show(success_screen)</text><polygon fill="#000000" points="259,2924.7422,249,2928.7422,259,2932.7422,255,2928.7422" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="253" x2="722" y1="2928.7422" y2="2928.7422"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="185" x="265" y="2923.6763">"Программа активирована"</text><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1.0;" width="1955" x="5" y="2964.3086"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1960" y1="2964.3086" y2="2964.3086"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1960" y1="2967.3086" y2="2967.3086"/><rect fill="#FFFFFF" height="23.1328" style="stroke:#000000;stroke-width:1.0;" width="241" x="862" y="2953.7422"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="222" x="868" y="2969.8091">Progress / Charts (matplotlib)</text><polygon fill="#000000" points="236,3004.0078,246,3008.0078,236,3012.0078,240,3008.0078" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="44" x2="242" y1="3008.0078" y2="3008.0078"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="72" x="51" y="3002.9419">"Прогресс"</text><polygon fill="#000000" points="505,3033.1406,515,3037.1406,505,3041.1406,509,3037.1406" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="248" x2="511" y1="3037.1406" y2="3037.1406"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="169" x="255" y="3032.0747">Callback(progress_screen)</text><path d="M188.5,3052.1406 L252.5,3052.1406 L252.5,3059.2734 L242.5,3069.2734 L188.5,3069.2734 L188.5,3052.1406 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="438.7969" style="stroke:#000000;stroke-width:1.0;" width="1645.5" x="188.5" y="3052.1406"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="203.5" y="3065.2075">alt</text><text fill="#000000" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="214" x="267.5" y="3064.3511">[CHARTS_ENABLED (feature flag)]</text><polygon fill="#000000" points="1332.5,3086.4063,1342.5,3090.4063,1332.5,3094.4063,1336.5,3090.4063" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="517" x2="1338.5" y1="3090.4063" y2="3090.4063"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="177" x="524" y="3085.3403">build_progress_report(user)</text><polygon fill="#000000" points="1784.5,3115.5391,1794.5,3119.5391,1784.5,3123.5391,1788.5,3119.5391" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1344.5" x2="1790.5" y1="3119.5391" y2="3119.5391"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="194" x="1351.5" y="3114.4731">load workouts/sets/weight logs</text><polygon fill="#000000" points="1355.5,3144.6719,1345.5,3148.6719,1355.5,3152.6719,1351.5,3148.6719" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1349.5" x2="1795.5" y1="3148.6719" y2="3148.6719"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="29" x="1361.5" y="3143.606">data</text><line style="stroke:#000000;stroke-width:1.0;" x1="1344.5" x2="1386.5" y1="3192.9375" y2="3192.9375"/><line style="stroke:#000000;stroke-width:1.0;" x1="1386.5" x2="1386.5" y1="3192.9375" y2="3205.9375"/><line style="stroke:#000000;stroke-width:1.0;" x1="1345.5" x2="1386.5" y1="3205.9375" y2="3205.9375"/><polygon fill="#000000" points="1355.5,3201.9375,1345.5,3205.9375,1355.5,3209.9375,1351.5,3205.9375" style="stroke:#000000;stroke-width:1.0;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="123" x="1351.5" y="3172.7388">render_chart_png()</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="107" x="1351.5" y="3187.8716">(matplotlib, Agg)</text><polygon fill="#000000" points="528,3231.0703,518,3235.0703,528,3239.0703,524,3235.0703" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="522" x2="1343.5" y1="3235.0703" y2="3235.0703"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="114" x="534" y="3230.0044">stats + png bytes</text><polygon fill="#000000" points="259,3260.2031,249,3264.2031,259,3268.2031,255,3264.2031" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="253" x2="516" y1="3264.2031" y2="3264.2031"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="118" x="265" y="3259.1372">send_photo(chart)</text><polygon fill="#000000" points="711,3289.3359,721,3293.3359,711,3297.3359,715,3293.3359" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="517" x2="717" y1="3293.3359" y2="3293.3359"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="148" x="524" y="3288.27">show(progress_screen)</text><polygon fill="#000000" points="259,3318.4688,249,3322.4688,259,3326.4688,255,3322.4688" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="253" x2="722" y1="3322.4688" y2="3322.4688"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="61" x="265" y="3317.4028">stats text</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="188.5" x2="1834" y1="3331.4688" y2="3331.4688"/><text fill="#000000" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="111" x="193.5" y="3341.6792">[Charts disabled]</text><polygon fill="#000000" points="1332.5,3362.4063,1342.5,3366.4063,1332.5,3370.4063,1336.5,3366.4063" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="517" x2="1338.5" y1="3366.4063" y2="3366.4063"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="146" x="524" y="3361.3403">build_text_report(user)</text><polygon fill="#000000" points="1784.5,3391.5391,1794.5,3395.5391,1784.5,3399.5391,1788.5,3395.5391" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1344.5" x2="1790.5" y1="3395.5391" y2="3395.5391"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="118" x="1351.5" y="3390.4731">load minimal stats</text><polygon fill="#000000" points="1355.5,3420.6719,1345.5,3424.6719,1355.5,3428.6719,1351.5,3424.6719" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1349.5" x2="1795.5" y1="3424.6719" y2="3424.6719"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="29" x="1361.5" y="3419.606">data</text><polygon fill="#000000" points="528,3449.8047,518,3453.8047,528,3457.8047,524,3453.8047" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="522" x2="1343.5" y1="3453.8047" y2="3453.8047"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="61" x="534" y="3448.7388">text stats</text><polygon fill="#000000" points="711,3478.9375,721,3482.9375,711,3486.9375,715,3482.9375" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="517" x2="717" y1="3482.9375" y2="3482.9375"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="148" x="524" y="3477.8716">show(progress_screen)</text><polygon fill="#000000" points="55,3515.0703,45,3519.0703,55,3523.0703,51,3519.0703" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="49" x2="247" y1="3519.0703" y2="3519.0703"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="99" x="61" y="3514.0044">progress report</text><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1.0;" width="1955" x="5" y="3547.6367"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1960" y1="3547.6367" y2="3547.6367"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1960" y1="3550.6367" y2="3550.6367"/><rect fill="#FFFFFF" height="23.1328" style="stroke:#000000;stroke-width:1.0;" width="298" x="833.5" y="3537.0703"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="279" x="839.5" y="3553.1372">AI Coach (ask question / daily advice)</text><path d="M15,3577.2031 L79,3577.2031 L79,3584.3359 L69,3594.3359 L15,3594.3359 L15,3577.2031 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="715.125" style="stroke:#000000;stroke-width:1.0;" width="1935" x="15" y="3577.2031"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="30" y="3590.27">alt</text><text fill="#000000" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="176" x="94" y="3589.4136">[AI_ENABLED (feature flag)]</text><polygon fill="#000000" points="236,3611.4688,246,3615.4688,236,3619.4688,240,3615.4688" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="44" x2="242" y1="3615.4688" y2="3615.4688"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="66" x="51" y="3610.4028">"AI Coach"</text><polygon fill="#000000" points="505,3640.6016,515,3644.6016,505,3648.6016,509,3644.6016" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="248" x2="511" y1="3644.6016" y2="3644.6016"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="118" x="255" y="3639.5356">Callback(ai_menu)</text><path d="M354,3657.6016 L354,3697.6016 L679,3697.6016 L679,3667.6016 L669,3657.6016 L354,3657.6016 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><path d="M669,3657.6016 L669,3667.6016 L679,3667.6016 L669,3657.6016 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="187" x="360" y="3674.6685">If SUBSCRIPTIONS_ENABLED,</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="304" x="360" y="3689.8013">AI sections may be gated by active subscription</text><polygon fill="#000000" points="711,3720,721,3724,711,3728,715,3724" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="517" x2="717" y1="3724" y2="3724"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="97" x="524" y="3718.9341">show(ai_menu)</text><polygon fill="#000000" points="259,3749.1328,249,3753.1328,259,3757.1328,255,3753.1328" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="253" x2="722" y1="3753.1328" y2="3753.1328"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="47" x="265" y="3748.0669">options</text><polygon fill="#000000" points="55,3778.2656,45,3782.2656,55,3786.2656,51,3782.2656" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="49" x2="247" y1="3782.2656" y2="3782.2656"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="37" x="61" y="3777.1997">menu</text><polygon fill="#000000" points="236,3807.3984,246,3811.3984,236,3815.3984,240,3811.3984" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="44" x2="242" y1="3811.3984" y2="3811.3984"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="113" x="51" y="3806.3325">"Задать вопрос"</text><polygon fill="#000000" points="505,3836.5313,515,3840.5313,505,3844.5313,509,3840.5313" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="248" x2="511" y1="3840.5313" y2="3840.5313"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="103" x="255" y="3835.4653">Callback(ask_ai)</text><polygon fill="#000000" points="711,3880.7969,721,3884.7969,711,3888.7969,715,3884.7969" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="517" x2="717" y1="3884.7969" y2="3884.7969"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="151" x="524" y="3864.5981">show(question_prompt)</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="165" x="524" y="3879.731">(FSM waiting_ai_question)</text><polygon fill="#000000" points="259,3909.9297,249,3913.9297,259,3917.9297,255,3913.9297" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="253" x2="722" y1="3913.9297" y2="3913.9297"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="47" x="265" y="3908.8638">prompt</text><polygon fill="#000000" points="55,3939.0625,45,3943.0625,55,3947.0625,51,3943.0625" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="49" x2="247" y1="3943.0625" y2="3943.0625"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="47" x="61" y="3937.9966">prompt</text><polygon fill="#000000" points="236,3968.1953,246,3972.1953,236,3976.1953,240,3972.1953" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="44" x2="242" y1="3972.1953" y2="3972.1953"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="84" x="51" y="3967.1294">question text</text><polygon fill="#000000" points="505,3997.3281,515,4001.3281,505,4005.3281,509,4001.3281" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="248" x2="511" y1="4001.3281" y2="4001.3281"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="122" x="255" y="3996.2622">Message(question)</text><polygon fill="#000000" points="1485.5,4026.4609,1495.5,4030.4609,1485.5,4034.4609,1489.5,4030.4609" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="517" x2="1491.5" y1="4030.4609" y2="4030.4609"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="208" x="524" y="4025.395">answer_question(user, question)</text><polygon fill="#000000" points="1784.5,4055.5938,1794.5,4059.5938,1784.5,4063.5938,1788.5,4059.5938" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1497.5" x2="1790.5" y1="4059.5938" y2="4059.5938"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="275" x="1504.5" y="4054.5278">load context (profile + workouts + metrics)</text><polygon fill="#000000" points="1508.5,4084.7266,1498.5,4088.7266,1508.5,4092.7266,1504.5,4088.7266" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1502.5" x2="1795.5" y1="4088.7266" y2="4088.7266"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="48" x="1514.5" y="4083.6606">context</text><polygon fill="#000000" points="1875,4113.8594,1885,4117.8594,1875,4121.8594,1879,4117.8594" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1497.5" x2="1881" y1="4117.8594" y2="4117.8594"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="154" x="1504.5" y="4112.7935">ask(question + context)</text><polygon fill="#000000" points="1508.5,4142.9922,1498.5,4146.9922,1508.5,4150.9922,1504.5,4146.9922" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1502.5" x2="1886" y1="4146.9922" y2="4146.9922"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="45" x="1514.5" y="4141.9263">answer</text><polygon fill="#000000" points="528,4172.125,518,4176.125,528,4180.125,524,4176.125" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="522" x2="1496.5" y1="4176.125" y2="4176.125"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="45" x="534" y="4171.0591">answer</text><polygon fill="#000000" points="711,4201.2578,721,4205.2578,711,4209.2578,715,4205.2578" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="517" x2="717" y1="4205.2578" y2="4205.2578"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="119" x="524" y="4200.1919">show(ai_response)</text><polygon fill="#000000" points="259,4230.3906,249,4234.3906,259,4238.3906,255,4234.3906" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="253" x2="722" y1="4234.3906" y2="4234.3906"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="45" x="265" y="4229.3247">answer</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="15" x2="1950" y1="4243.3906" y2="4243.3906"/><text fill="#000000" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="81" x="20" y="4253.6011">[AI disabled]</text><path d="M404,4262.1953 L404,4287.1953 L629,4287.1953 L629,4272.1953 L619,4262.1953 L404,4262.1953 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><path d="M619,4262.1953 L619,4272.1953 L629,4272.1953 L619,4262.1953 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="204" x="410" y="4279.2622">Hide AI menu / show info screen</text><!--MD5=[a466f07a4ce5488c18c4bd5354cd13d9]
@startuml
!theme plain
title Telegram Fitness Bot - Monetization & Engagement — Sequence Diagram (Charts + AI Coach)

actor User
participant "Telegram" as TG
participant "Handlers" as H
participant "ScreenManager" as SM
participant "WalletService" as WS
participant "SubscriptionService" as SS
participant "ProgramService" as PS
participant "ProgressService" as PR
participant "AICoachService" as AIc
participant "DB" as DB
participant "AI Provider" as AI

== Wallet ==
User -> TG: "Баланс"
TG -> H: Callback(wallet_screen)
H -> WS: get_or_create_wallet(user)
WS -> DB: wallet upsert/select
DB - -> WS: wallet
WS - -> H: wallet
H -> SM: show(wallet_screen)
SM - -> TG: balance + actions
TG - -> User: wallet

== Top-up via Telegram Payments (if enabled) ==
alt PAYMENTS_ENABLED (feature flag)
  User -> TG: "Пополнить"
  TG -> H: Callback(topup)
  H -> WS: create_invoice(package)
  WS - -> H: invoice payload
  H -> TG: send_invoice(payload)
  TG - -> User: payment UI

  TG -> H: pre_checkout_query
  H - -> TG: answer_pre_checkout(ok)

  TG -> H: successful_payment(payload)
  H -> WS: apply_topup(payload)
  WS -> DB: insert_transaction(type="topup")\n+ update wallet coins
  DB - -> WS: ok
  WS - -> H: ok
  H -> SM: refresh(wallet_screen)
  SM - -> TG: updated balance
else Payments disabled
  note over H: show info / hide topup buttons
end

== Subscription (paid by coins) ==
User -> TG: "Подписка"
TG -> H: Callback(subscription_screen)
H -> SS: get_status(user)
SS -> DB: select subscription
DB - -> SS: active/none
SS - -> H: status
H -> WS: get_wallet(user)
WS -> DB: select wallet
DB - -> WS: wallet
WS - -> H: wallet
H -> SM: show(subscription_screen)
SM - -> TG: status + buy/cancel
TG - -> User: subscription

User -> TG: "Купить"
TG -> H: Callback(buy_subscription)
H -> SS: purchase_for_coins(user)
SS -> DB: lock/select wallet
DB - -> SS: wallet
alt Not enough coins
  SS - -> H: error("Недостаточно монет")
  H -> SM: show(wallet_topup_hint)
  SM - -> TG: hint
else Enough coins
  SS -> DB: insert spend transaction\n+ update wallet\n+ upsert subscription(active_until)
  DB - -> SS: ok
  SS - -> H: ok
  H -> SM: refresh(subscription_screen)
  SM - -> TG: updated status
end

== Programs (catalog / buy / activate) ==
note over PS: Program data is seeded from YAML at startup
User -> TG: "📋 Программы"
TG -> H: Callback(programs_screen)
H -> PS: list_programs(user)
PS -> DB: select programs + ownership/prices
DB - -> PS: list
PS - -> H: list
H -> SM: show(programs_list)
SM - -> TG: catalog
TG - -> User: catalog

User -> TG: "Купить" / "Активировать"
TG -> H: Callback(program_action, program_id)

alt action == buy (price in coins)
  H -> PS: buy_program_for_coins(user, program_id)
  PS -> DB: select wallet
  DB - -> PS: wallet
  alt Not enough coins
    PS - -> H: error("Недостаточно монет")
    H -> SM: show(wallet_topup_hint)
    SM - -> TG: hint
  else Enough coins
    PS -> DB: insert spend transaction\n+ update wallet\n+ mark program owned
    DB - -> PS: ok
    PS - -> H: purchased
    H -> SM: refresh(programs_list)
    SM - -> TG: updated catalog
  end
else action == activate
  H -> PS: activate_program(user, program_id)
  PS -> DB: set previous active=false\n+ set new active=true\n+ set current_week/day_key
  DB - -> PS: ok
  PS - -> H: activated
  H -> SM: show(success_screen)
  SM - -> TG: "Программа активирована"
end

== Progress / Charts (matplotlib) ==
User -> TG: "Прогресс"
TG -> H: Callback(progress_screen)

alt CHARTS_ENABLED (feature flag)
  H -> PR: build_progress_report(user)
  PR -> DB: load workouts/sets/weight logs
  DB - -> PR: data
  PR -> PR: render_chart_png()\n(matplotlib, Agg)
  PR - -> H: stats + png bytes
  H -> TG: send_photo(chart)
  H -> SM: show(progress_screen)
  SM - -> TG: stats text
else Charts disabled
  H -> PR: build_text_report(user)
  PR -> DB: load minimal stats
  DB - -> PR: data
  PR - -> H: text stats
  H -> SM: show(progress_screen)
end
TG - -> User: progress report

== AI Coach (ask question / daily advice) ==
alt AI_ENABLED (feature flag)
  User -> TG: "AI Coach"
  TG -> H: Callback(ai_menu)

  note over H: If SUBSCRIPTIONS_ENABLED,\nAI sections may be gated by active subscription
  H -> SM: show(ai_menu)
  SM - -> TG: options
  TG - -> User: menu

  User -> TG: "Задать вопрос"
  TG -> H: Callback(ask_ai)
  H -> SM: show(question_prompt)\n(FSM waiting_ai_question)
  SM - -> TG: prompt
  TG - -> User: prompt

  User -> TG: question text
  TG -> H: Message(question)
  H -> AIc: answer_question(user, question)
  AIc -> DB: load context (profile + workouts + metrics)
  DB - -> AIc: context
  AIc -> AI: ask(question + context)
  AI - -> AIc: answer
  AIc - -> H: answer
  H -> SM: show(ai_response)
  SM - -> TG: answer
else AI disabled
  note over H: Hide AI menu / show info screen
end
@enduml

@startuml







<style>
  root {
    BackgroundColor white
    FontColor black
    FontName Verdana
    HyperLinkColor blue
    LineColor black
    LineThickness 1
    Margin 5
  }
  caption {
    LineThickness 0
  }
  footer {
    LineThickness 0
  }
  header {
    LineThickness 0
  }
  node {
    MaximumWidth 300
  }
  title {
    FontSize 22
    LineThickness 0
  }
</style>

skinparam ArrowLollipopColor black
skinparam BackgroundColor white
skinparam DefaultFontName Verdana
skinparam DefaultMonospacedFontName Courier
skinparam LifelineStrategy nosolid
skinparam ParticipantPadding 10
skinparam SequenceLifeLineBorderColor black
skinparam Shadowing false
skinparam UseBetaStyle true

skinparam Activity {
  BackgroundColor white
  BarColor black
  BorderColor black
  FontColor black
  FontName Verdana
}
skinparam Boundary {
  FontColor black
}
skinparam Box {
  Padding 5
}
skinparam CircledCharacter {
  FontColor black
  FontName Courier
  Radius 9
}
skinparam Class {
  BackgroundColor white
  BorderColor black
  FontColor black
  FontName Verdana
}
skinparam ClassAttribute {
  FontColor black
  FontName Verdana
}
skinparam ClassStereotype {
  FontColor black
  FontName Verdana
}
skinparam Footer {
  FontColor black
  FontName Verdana
}
skinparam Header {
  FontColor black
  FontName Verdana
}
skinparam Hyperlink {
  Color blue
}
skinparam IconPackage {
  Color black
  BackgroundColor white
}
skinparam IconPrivate {
  Color black
  BackgroundColor white
}
skinparam IconProtected {
  Color black
  BackgroundColor white
}
skinparam IconPublic {
  Color black
  BackgroundColor white
}
skinparam Note {
  FontColor black
  FontName Verdana
}
skinparam Object {
  BorderColor black
}
skinparam Package {
  BorderColor black
  FontColor black
  FontName Verdana
}
skinparam State {
  BackgroundColor white
  BorderColor black
}
skinparam StereotypeA {
  BackgroundColor white
  BorderColor black
}
skinparam StereotypeC {
  BackgroundColor white
  BorderColor black
}
skinparam StereotypeE {
  BackgroundColor white
  BorderColor black
}
skinparam StereotypeI {
  BackgroundColor white
  BorderColor black
}
skinparam StereotypeN {
  BackgroundColor white
  BorderColor black
}
skinparam UseCaseStereoType {
  FontColor black
  FontName Verdana
}
title Telegram Fitness Bot - Monetization & Engagement — Sequence Diagram (Charts + AI Coach)

actor User
participant "Telegram" as TG
participant "Handlers" as H
participant "ScreenManager" as SM
participant "WalletService" as WS
participant "SubscriptionService" as SS
participant "ProgramService" as PS
participant "ProgressService" as PR
participant "AICoachService" as AIc
participant "DB" as DB
participant "AI Provider" as AI

== Wallet ==
User -> TG: "Баланс"
TG -> H: Callback(wallet_screen)
H -> WS: get_or_create_wallet(user)
WS -> DB: wallet upsert/select
DB - -> WS: wallet
WS - -> H: wallet
H -> SM: show(wallet_screen)
SM - -> TG: balance + actions
TG - -> User: wallet

== Top-up via Telegram Payments (if enabled) ==
alt PAYMENTS_ENABLED (feature flag)
  User -> TG: "Пополнить"
  TG -> H: Callback(topup)
  H -> WS: create_invoice(package)
  WS - -> H: invoice payload
  H -> TG: send_invoice(payload)
  TG - -> User: payment UI

  TG -> H: pre_checkout_query
  H - -> TG: answer_pre_checkout(ok)

  TG -> H: successful_payment(payload)
  H -> WS: apply_topup(payload)
  WS -> DB: insert_transaction(type="topup")\n+ update wallet coins
  DB - -> WS: ok
  WS - -> H: ok
  H -> SM: refresh(wallet_screen)
  SM - -> TG: updated balance
else Payments disabled
  note over H: show info / hide topup buttons
end

== Subscription (paid by coins) ==
User -> TG: "Подписка"
TG -> H: Callback(subscription_screen)
H -> SS: get_status(user)
SS -> DB: select subscription
DB - -> SS: active/none
SS - -> H: status
H -> WS: get_wallet(user)
WS -> DB: select wallet
DB - -> WS: wallet
WS - -> H: wallet
H -> SM: show(subscription_screen)
SM - -> TG: status + buy/cancel
TG - -> User: subscription

User -> TG: "Купить"
TG -> H: Callback(buy_subscription)
H -> SS: purchase_for_coins(user)
SS -> DB: lock/select wallet
DB - -> SS: wallet
alt Not enough coins
  SS - -> H: error("Недостаточно монет")
  H -> SM: show(wallet_topup_hint)
  SM - -> TG: hint
else Enough coins
  SS -> DB: insert spend transaction\n+ update wallet\n+ upsert subscription(active_until)
  DB - -> SS: ok
  SS - -> H: ok
  H -> SM: refresh(subscription_screen)
  SM - -> TG: updated status
end

== Programs (catalog / buy / activate) ==
note over PS: Program data is seeded from YAML at startup
User -> TG: "📋 Программы"
TG -> H: Callback(programs_screen)
H -> PS: list_programs(user)
PS -> DB: select programs + ownership/prices
DB - -> PS: list
PS - -> H: list
H -> SM: show(programs_list)
SM - -> TG: catalog
TG - -> User: catalog

User -> TG: "Купить" / "Активировать"
TG -> H: Callback(program_action, program_id)

alt action == buy (price in coins)
  H -> PS: buy_program_for_coins(user, program_id)
  PS -> DB: select wallet
  DB - -> PS: wallet
  alt Not enough coins
    PS - -> H: error("Недостаточно монет")
    H -> SM: show(wallet_topup_hint)
    SM - -> TG: hint
  else Enough coins
    PS -> DB: insert spend transaction\n+ update wallet\n+ mark program owned
    DB - -> PS: ok
    PS - -> H: purchased
    H -> SM: refresh(programs_list)
    SM - -> TG: updated catalog
  end
else action == activate
  H -> PS: activate_program(user, program_id)
  PS -> DB: set previous active=false\n+ set new active=true\n+ set current_week/day_key
  DB - -> PS: ok
  PS - -> H: activated
  H -> SM: show(success_screen)
  SM - -> TG: "Программа активирована"
end

== Progress / Charts (matplotlib) ==
User -> TG: "Прогресс"
TG -> H: Callback(progress_screen)

alt CHARTS_ENABLED (feature flag)
  H -> PR: build_progress_report(user)
  PR -> DB: load workouts/sets/weight logs
  DB - -> PR: data
  PR -> PR: render_chart_png()\n(matplotlib, Agg)
  PR - -> H: stats + png bytes
  H -> TG: send_photo(chart)
  H -> SM: show(progress_screen)
  SM - -> TG: stats text
else Charts disabled
  H -> PR: build_text_report(user)
  PR -> DB: load minimal stats
  DB - -> PR: data
  PR - -> H: text stats
  H -> SM: show(progress_screen)
end
TG - -> User: progress report

== AI Coach (ask question / daily advice) ==
alt AI_ENABLED (feature flag)
  User -> TG: "AI Coach"
  TG -> H: Callback(ai_menu)

  note over H: If SUBSCRIPTIONS_ENABLED,\nAI sections may be gated by active subscription
  H -> SM: show(ai_menu)
  SM - -> TG: options
  TG - -> User: menu

  User -> TG: "Задать вопрос"
  TG -> H: Callback(ask_ai)
  H -> SM: show(question_prompt)\n(FSM waiting_ai_question)
  SM - -> TG: prompt
  TG - -> User: prompt

  User -> TG: question text
  TG -> H: Message(question)
  H -> AIc: answer_question(user, question)
  AIc -> DB: load context (profile + workouts + metrics)
  DB - -> AIc: context
  AIc -> AI: ask(question + context)
  AI - -> AIc: answer
  AIc - -> H: answer
  H -> SM: show(ai_response)
  SM - -> TG: answer
else AI disabled
  note over H: Hide AI menu / show info screen
end
@enduml

PlantUML version 1.2022.7(Mon Aug 22 17:01:30 UTC 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: null
--></g></svg>
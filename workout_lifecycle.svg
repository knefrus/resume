<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="2864px" preserveAspectRatio="none" style="width:1928px;height:2864px;background:#FFFFFF;" version="1.1" viewBox="0 0 1928 2864" width="1928px" zoomAndPan="magnify"><defs/><g><rect fill="#FFFFFF" height="35.6094" id="_title" style="stroke:#FFFFFF;stroke-width:0.0;" width="1177" x="374" y="10"/><text fill="#000000" font-family="Verdana" font-size="22" font-weight="bold" lengthAdjust="spacing" textLength="1167" x="379" y="35.4209">Telegram Fitness Bot - Workout Lifecycle — Sequence Diagram (FSM, AI feedback, Recovery)</text><rect fill="#FFFFFF" height="280.1328" style="stroke:#000000;stroke-width:1.0;" width="1421.5" x="122.5" y="604.0313"/><rect fill="#FFFFFF" height="175.6016" style="stroke:none;stroke-width:1.0;" width="1421.5" x="122.5" y="708.5625"/><rect fill="#FFFFFF" height="308.4609" style="stroke:#000000;stroke-width:1.0;" width="1529" x="15" y="970.4297"/><rect fill="#FFFFFF" height="583.4609" style="stroke:#000000;stroke-width:1.0;" width="1797" x="15" y="1525.9531"/><rect fill="#FFFFFF" height="49.9375" style="stroke:none;stroke-width:1.0;" width="1797" x="15" y="2059.4766"/><rect fill="#FFFFFF" height="133.6641" style="stroke:#000000;stroke-width:1.0;" width="1529" x="15" y="2341.3438"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="44" x2="44" y1="128.9063" y2="2783.3359"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="181.5" x2="181.5" y1="128.9063" y2="2783.3359"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="369" x2="369" y1="128.9063" y2="2783.3359"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="576" x2="576" y1="128.9063" y2="2783.3359"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="742" x2="742" y1="128.9063" y2="2783.3359"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="933" x2="933" y1="128.9063" y2="2783.3359"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1200" x2="1200" y1="128.9063" y2="2783.3359"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1472" x2="1472" y1="128.9063" y2="2783.3359"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1673" x2="1673" y1="128.9063" y2="2783.3359"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1864" x2="1864" y1="128.9063" y2="2783.3359"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="32" x="25" y="125.6045">User</text><ellipse cx="44" cy="60.6094" fill="#FFFFFF" rx="8" ry="8" style="stroke:#000000;stroke-width:1.0;"/><path d="M44,68.6094 L44,95.6094 M31,76.6094 L57,76.6094 M44,95.6094 L31,110.6094 M44,95.6094 L57,110.6094 " fill="none" style="stroke:#000000;stroke-width:1.0;"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="32" x="25" y="2795.3311">User</text><ellipse cx="44" cy="2807.6328" fill="#FFFFFF" rx="8" ry="8" style="stroke:#000000;stroke-width:1.0;"/><path d="M44,2815.6328 L44,2842.6328 M31,2823.6328 L57,2823.6328 M44,2842.6328 L31,2857.6328 M44,2842.6328 L57,2857.6328 " fill="none" style="stroke:#000000;stroke-width:1.0;"/><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="79" x="142.5" y="97.6094"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="65" x="149.5" y="117.6045">Telegram</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="79" x="142.5" y="2782.3359"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="65" x="149.5" y="2802.3311">Telegram</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="198" x="270" y="97.6094"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="184" x="277" y="117.6045">Handlers (aiogram routers)</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="198" x="270" y="2782.3359"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="184" x="277" y="2802.3311">Handlers (aiogram routers)</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="150" x="501" y="97.6094"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="136" x="508" y="117.6045">ScreenManager (UI)</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="150" x="501" y="2782.3359"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="136" x="508" y="2802.3311">ScreenManager (UI)</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="122" x="681" y="97.6094"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="108" x="688" y="117.6045">WorkoutService</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="122" x="681" y="2782.3359"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="108" x="688" y="2802.3311">WorkoutService</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="201" x="833" y="97.6094"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="187" x="840" y="117.6045">AICoachService (AI-логика)</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="201" x="833" y="2782.3359"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="187" x="840" y="2802.3311">AICoachService (AI-логика)</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="272" x="1064" y="97.6094"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="258" x="1071" y="117.6045">ReminderService (отлож. действия)</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="272" x="1064" y="2782.3359"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="258" x="1071" y="2802.3311">ReminderService (отлож. действия)</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="104" x="1420" y="97.6094"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="90" x="1427" y="117.6045">DB - данные</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="104" x="1420" y="2782.3359"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="90" x="1427" y="2802.3311">DB - данные</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="238" x="1554" y="97.6094"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="224" x="1561" y="117.6045">AI Provider (внешний API - Groq)</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="238" x="1554" y="2782.3359"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="224" x="1561" y="2802.3311">AI Provider (внешний API - Groq)</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="84" x="1822" y="97.6094"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="70" x="1829" y="117.6045">Scheduler</text><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.0;" width="84" x="1822" y="2782.3359"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="70" x="1829" y="2802.3311">Scheduler</text><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1.0;" width="1916" x="5" y="159.4727"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1921" y1="159.4727" y2="159.4727"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1921" y1="162.4727" y2="162.4727"/><rect fill="#FFFFFF" height="23.1328" style="stroke:#000000;stroke-width:1.0;" width="59" x="933.5" y="148.9063"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="40" x="939.5" y="164.9731">/start</text><polygon fill="#000000" points="170,199.1719,180,203.1719,170,207.1719,174,203.1719" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="44" x2="176" y1="203.1719" y2="203.1719"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="34" x="51" y="198.106">/start</text><polygon fill="#000000" points="357,228.3047,367,232.3047,357,236.3047,361,232.3047" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="182" x2="363" y1="232.3047" y2="232.3047"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="111" x="189" y="227.2388">Message("/start")</text><path d="M292,245.3047 L292,315.3047 L445,315.3047 L445,255.3047 L435,245.3047 L292,245.3047 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><path d="M435,245.3047 L435,255.3047 L445,255.3047 L435,245.3047 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="120" x="298" y="262.3716">Middlewares inject:</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="97" x="298" y="277.5044">- AsyncSession</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="132" x="298" y="292.6372">- get_or_create User</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="110" x="298" y="307.77">- ScreenManager</text><polygon fill="#000000" points="564,337.9688,574,341.9688,564,345.9688,568,341.9688" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="369" x2="570" y1="341.9688" y2="341.9688"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="118" x="376" y="336.9028">show(main_menu)</text><polygon fill="#000000" points="193,367.1016,183,371.1016,193,375.1016,189,371.1016" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="187" x2="575" y1="371.1016" y2="371.1016"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="112" x="199" y="366.0356">welcome + menu</text><polygon fill="#000000" points="55,396.2344,45,400.2344,55,404.2344,51,400.2344" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="49" x2="181" y1="400.2344" y2="400.2344"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="37" x="61" y="395.1685">menu</text><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1.0;" width="1916" x="5" y="428.8008"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1921" y1="428.8008" y2="428.8008"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1921" y1="431.8008" y2="431.8008"/><rect fill="#FFFFFF" height="23.1328" style="stroke:#000000;stroke-width:1.0;" width="122" x="902" y="418.2344"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="103" x="908" y="434.3013">Start Workout</text><polygon fill="#000000" points="170,468.5,180,472.5,170,476.5,174,472.5" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="44" x2="176" y1="472.5" y2="472.5"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="89" x="51" y="467.4341">"Тренировка"</text><polygon fill="#000000" points="357,497.6328,367,501.6328,357,505.6328,361,501.6328" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="182" x2="363" y1="501.6328" y2="501.6328"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="163" x="189" y="496.5669">Callback(workout_screen)</text><polygon fill="#000000" points="730,526.7656,740,530.7656,730,534.7656,734,530.7656" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="369" x2="736" y1="530.7656" y2="530.7656"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="155" x="376" y="525.6997">can_start_workout(user)</text><polygon fill="#000000" points="1460,555.8984,1470,559.8984,1460,563.8984,1464,559.8984" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="742" x2="1466" y1="559.8984" y2="559.8984"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="177" x="749" y="554.8325">check_active_workout(user)</text><polygon fill="#000000" points="753,585.0313,743,589.0313,753,593.0313,749,589.0313" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="747" x2="1471" y1="589.0313" y2="589.0313"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="73" x="759" y="583.9653">none/exists</text><path d="M122.5,604.0313 L186.5,604.0313 L186.5,611.1641 L176.5,621.1641 L122.5,621.1641 L122.5,604.0313 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="280.1328" style="stroke:#000000;stroke-width:1.0;" width="1421.5" x="122.5" y="604.0313"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="137.5" y="617.0981">alt</text><text fill="#000000" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="181" x="201.5" y="616.2417">[Есть активная тренировка]</text><polygon fill="#000000" points="380,638.2969,370,642.2969,380,646.2969,376,642.2969" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="374" x2="741" y1="642.2969" y2="642.2969"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="194" x="386" y="637.231">deny("workout already active")</text><polygon fill="#000000" points="564,667.4297,574,671.4297,564,675.4297,568,671.4297" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="369" x2="570" y1="671.4297" y2="671.4297"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="115" x="376" y="666.3638">show(info_screen)</text><polygon fill="#000000" points="193,696.5625,183,700.5625,193,704.5625,189,700.5625" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="187" x2="575" y1="700.5625" y2="700.5625"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="23" x="199" y="695.4966">info</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="122.5" x2="1544" y1="709.5625" y2="709.5625"/><text fill="#000000" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="69" x="127.5" y="719.7729">[Can start]</text><polygon fill="#000000" points="1460,755.6328,1470,759.6328,1460,763.6328,1464,759.6328" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="742" x2="1466" y1="759.6328" y2="759.6328"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="136" x="749" y="739.4341">create_workout(user)</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="85" x="749" y="754.5669">+ initial state</text><polygon fill="#000000" points="753,784.7656,743,788.7656,753,792.7656,749,788.7656" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="747" x2="1471" y1="788.7656" y2="788.7656"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="120" x="759" y="783.6997">workout_id + state</text><polygon fill="#000000" points="380,813.8984,370,817.8984,380,821.8984,376,817.8984" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="374" x2="741" y1="817.8984" y2="817.8984"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="103" x="386" y="812.8325">workout_started</text><polygon fill="#000000" points="564,843.0313,574,847.0313,564,851.0313,568,847.0313" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="369" x2="570" y1="847.0313" y2="847.0313"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="170" x="376" y="841.9653">show(live_workout_screen)</text><polygon fill="#000000" points="193,872.1641,183,876.1641,193,880.1641,189,876.1641" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="187" x2="575" y1="876.1641" y2="876.1641"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="182" x="199" y="871.0981">current exercise + input hint</text><polygon fill="#000000" points="55,908.2969,45,912.2969,55,916.2969,51,912.2969" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="49" x2="181" y1="912.2969" y2="912.2969"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="75" x="61" y="907.231">live workout</text><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1.0;" width="1916" x="5" y="940.8633"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1921" y1="940.8633" y2="940.8633"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1921" y1="943.8633" y2="943.8633"/><rect fill="#FFFFFF" height="23.1328" style="stroke:#000000;stroke-width:1.0;" width="234" x="846" y="930.2969"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="215" x="852" y="946.3638">Log sets (FSM waiting_input)</text><path d="M15,970.4297 L92,970.4297 L92,977.5625 L82,987.5625 L15,987.5625 L15,970.4297 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="308.4609" style="stroke:#000000;stroke-width:1.0;" width="1529" x="15" y="970.4297"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="32" x="30" y="983.4966">loop</text><text fill="#000000" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="138" x="107" y="982.6401">[Each user input line]</text><polygon fill="#000000" points="170,1004.6953,180,1008.6953,170,1012.6953,174,1008.6953" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="44" x2="176" y1="1008.6953" y2="1008.6953"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="46" x="51" y="1003.6294">"12 50"</text><polygon fill="#000000" points="357,1033.8281,367,1037.8281,357,1041.8281,361,1037.8281" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="182" x2="363" y1="1037.8281" y2="1037.8281"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="113" x="189" y="1032.7622">Message("12 50")</text><polygon fill="#000000" points="730,1062.9609,740,1066.9609,730,1070.9609,734,1066.9609" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="369" x2="736" y1="1066.9609" y2="1066.9609"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="137" x="376" y="1061.895">parse_set_input(text)</text><polygon fill="#000000" points="380,1092.0938,370,1096.0938,380,1100.0938,376,1096.0938" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="374" x2="741" y1="1096.0938" y2="1096.0938"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="77" x="386" y="1091.0278">reps, weight</text><polygon fill="#000000" points="730,1121.2266,740,1125.2266,730,1129.2266,734,1125.2266" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="369" x2="736" y1="1125.2266" y2="1125.2266"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="214" x="376" y="1120.1606">add_set(workout_id, reps, weight)</text><polygon fill="#000000" points="1460,1150.3594,1470,1154.3594,1460,1158.3594,1464,1154.3594" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="742" x2="1466" y1="1154.3594" y2="1154.3594"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="142" x="749" y="1149.2935">insert_workout_set(...)</text><polygon fill="#000000" points="753,1179.4922,743,1183.4922,753,1187.4922,749,1183.4922" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="747" x2="1471" y1="1183.4922" y2="1183.4922"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="15" x="759" y="1178.4263">ok</text><polygon fill="#000000" points="380,1208.625,370,1212.625,380,1216.625,376,1212.625" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="374" x2="741" y1="1212.625" y2="1212.625"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="15" x="386" y="1207.5591">ok</text><polygon fill="#000000" points="564,1237.7578,574,1241.7578,564,1245.7578,568,1241.7578" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="369" x2="570" y1="1241.7578" y2="1241.7578"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="183" x="376" y="1236.6919">refresh(live_workout_screen)</text><polygon fill="#000000" points="193,1266.8906,183,1270.8906,193,1274.8906,189,1270.8906" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="187" x2="575" y1="1270.8906" y2="1270.8906"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="84" x="199" y="1265.8247">updated sets</text><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1.0;" width="1916" x="5" y="1306.457"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1921" y1="1306.457" y2="1306.457"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1921" y1="1309.457" y2="1309.457"/><rect fill="#FFFFFF" height="23.1328" style="stroke:#000000;stroke-width:1.0;" width="129" x="898.5" y="1295.8906"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="110" x="904.5" y="1311.9575">Finish Workout</text><polygon fill="#000000" points="170,1346.1563,180,1350.1563,170,1354.1563,174,1350.1563" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="44" x2="176" y1="1350.1563" y2="1350.1563"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="87" x="51" y="1345.0903">"Завершить"</text><polygon fill="#000000" points="357,1375.2891,367,1379.2891,357,1383.2891,361,1379.2891" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="182" x2="363" y1="1379.2891" y2="1379.2891"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="96" x="189" y="1374.2231">Callback(finish)</text><polygon fill="#000000" points="730,1404.4219,740,1408.4219,730,1412.4219,734,1408.4219" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="369" x2="736" y1="1408.4219" y2="1408.4219"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="168" x="376" y="1403.356">finish_workout(workout_id)</text><polygon fill="#000000" points="1460,1448.6875,1470,1452.6875,1460,1456.6875,1464,1452.6875" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="742" x2="1466" y1="1452.6875" y2="1452.6875"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="222" x="749" y="1432.4888">update_workout(status="finished")</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="137" x="749" y="1447.6216">+ compute summary</text><polygon fill="#000000" points="753,1477.8203,743,1481.8203,753,1485.8203,749,1481.8203" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="747" x2="1471" y1="1481.8203" y2="1481.8203"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="118" x="759" y="1476.7544">workout_summary</text><polygon fill="#000000" points="380,1506.9531,370,1510.9531,380,1514.9531,376,1510.9531" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="374" x2="741" y1="1510.9531" y2="1510.9531"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="118" x="386" y="1505.8872">workout_summary</text><path d="M15,1525.9531 L79,1525.9531 L79,1533.0859 L69,1543.0859 L15,1543.0859 L15,1525.9531 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="583.4609" style="stroke:#000000;stroke-width:1.0;" width="1797" x="15" y="1525.9531"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="30" y="1539.02">alt</text><text fill="#000000" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="86" x="94" y="1538.1636">[AI_ENABLED]</text><path d="M615,1548.0859 L615,1573.0859 L869,1573.0859 L869,1558.0859 L859,1548.0859 L615,1548.0859 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><path d="M859,1548.0859 L859,1558.0859 L869,1558.0859 L859,1548.0859 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="233" x="621" y="1565.1528">After finish, schedule recovery check</text><polygon fill="#000000" points="564,1610.4844,574,1614.4844,564,1618.4844,568,1614.4844" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="369" x2="570" y1="1614.4844" y2="1614.4844"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="154" x="376" y="1594.2856">show(feedback_prompt)</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="150" x="376" y="1609.4185">(FSM waiting_feedback)</text><polygon fill="#000000" points="193,1639.6172,183,1643.6172,193,1647.6172,189,1643.6172" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="187" x2="575" y1="1643.6172" y2="1643.6172"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="182" x="199" y="1638.5513">"Как прошла тренировка?"</text><polygon fill="#000000" points="55,1668.75,45,1672.75,55,1676.75,51,1672.75" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="49" x2="181" y1="1672.75" y2="1672.75"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="109" x="61" y="1667.6841">feedback prompt</text><polygon fill="#000000" points="170,1697.8828,180,1701.8828,170,1705.8828,174,1701.8828" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="44" x2="176" y1="1701.8828" y2="1701.8828"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="87" x="51" y="1696.8169">feedback text</text><polygon fill="#000000" points="357,1727.0156,367,1731.0156,357,1735.0156,361,1731.0156" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="182" x2="363" y1="1731.0156" y2="1731.0156"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="125" x="189" y="1725.9497">Message(feedback)</text><polygon fill="#000000" points="921.5,1756.1484,931.5,1760.1484,921.5,1764.1484,925.5,1760.1484" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="369" x2="927.5" y1="1760.1484" y2="1760.1484"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="238" x="376" y="1755.0825">analyze_feedback(feedback, context)</text><polygon fill="#000000" points="1460,1785.2813,1470,1789.2813,1460,1793.2813,1464,1789.2813" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="933.5" x2="1466" y1="1789.2813" y2="1789.2813"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="178" x="940.5" y="1784.2153">load_context(user, workout)</text><polygon fill="#000000" points="944.5,1814.4141,934.5,1818.4141,944.5,1822.4141,940.5,1818.4141" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="938.5" x2="1471" y1="1818.4141" y2="1818.4141"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="133" x="950.5" y="1813.3481">workouts/metrics/etc</text><polygon fill="#000000" points="1661,1843.5469,1671,1847.5469,1661,1851.5469,1665,1847.5469" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="933.5" x2="1667" y1="1847.5469" y2="1847.5469"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="184" x="940.5" y="1842.481">analyze(feedback + context)</text><polygon fill="#000000" points="944.5,1872.6797,934.5,1876.6797,944.5,1880.6797,940.5,1876.6797" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="938.5" x2="1672" y1="1876.6797" y2="1876.6797"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="199" x="950.5" y="1871.6138">structured analysis (RPE/notes)</text><polygon fill="#000000" points="1460,1901.8125,1470,1905.8125,1460,1909.8125,1464,1905.8125" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="933.5" x2="1466" y1="1905.8125" y2="1905.8125"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="271" x="940.5" y="1900.7466">save_workout_feedback(workout, analysis)</text><polygon fill="#000000" points="944.5,1930.9453,934.5,1934.9453,944.5,1938.9453,940.5,1934.9453" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="938.5" x2="1471" y1="1934.9453" y2="1934.9453"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="15" x="950.5" y="1929.8794">ok</text><polygon fill="#000000" points="380,1960.0781,370,1964.0781,380,1968.0781,376,1964.0781" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="374" x2="932.5" y1="1964.0781" y2="1964.0781"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="15" x="386" y="1959.0122">ok</text><polygon fill="#000000" points="1188,1989.2109,1198,1993.2109,1188,1997.2109,1192,1993.2109" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="369" x2="1194" y1="1993.2109" y2="1993.2109"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="259" x="376" y="1988.145">schedule_recovery_check(user, workout)</text><polygon fill="#000000" points="1460,2018.3438,1470,2022.3438,1460,2026.3438,1464,2022.3438" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1200" x2="1466" y1="2022.3438" y2="2022.3438"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="173" x="1207" y="2017.2778">create_recovery_record(...)</text><polygon fill="#000000" points="1211,2047.4766,1201,2051.4766,1211,2055.4766,1207,2051.4766" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1205" x2="1471" y1="2051.4766" y2="2051.4766"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="15" x="1217" y="2046.4106">ok</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="15" x2="1812" y1="2060.4766" y2="2060.4766"/><text fill="#000000" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="81" x="20" y="2070.687">[AI disabled]</text><path d="M271,2079.2813 L271,2104.2813 L467,2104.2813 L467,2089.2813 L457,2079.2813 L271,2079.2813 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><path d="M457,2079.2813 L457,2089.2813 L467,2089.2813 L457,2079.2813 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="175" x="277" y="2096.3481">Skip feedback + AI analysis</text><polygon fill="#000000" points="564,2133.5469,574,2137.5469,564,2141.5469,568,2137.5469" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="369" x2="570" y1="2137.5469" y2="2137.5469"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="138" x="376" y="2132.481">show(workout_report)</text><polygon fill="#000000" points="193,2162.6797,183,2166.6797,193,2170.6797,189,2166.6797" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="187" x2="575" y1="2166.6797" y2="2166.6797"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="39" x="199" y="2161.6138">report</text><polygon fill="#000000" points="55,2191.8125,45,2195.8125,55,2199.8125,51,2195.8125" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="49" x2="181" y1="2195.8125" y2="2195.8125"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="39" x="61" y="2190.7466">report</text><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1.0;" width="1916" x="5" y="2224.3789"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1921" y1="2224.3789" y2="2224.3789"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1921" y1="2227.3789" y2="2227.3789"/><rect fill="#FFFFFF" height="23.1328" style="stroke:#000000;stroke-width:1.0;" width="276" x="825" y="2213.8125"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="257" x="831" y="2229.8794">Recovery question (scheduled job)</text><polygon fill="#000000" points="1211,2264.0781,1201,2268.0781,1211,2272.0781,1207,2268.0781" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1205" x2="1863" y1="2268.0781" y2="2268.0781"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="178" x="1217" y="2263.0122">check_recovery_questions()</text><polygon fill="#000000" points="1460,2293.2109,1470,2297.2109,1460,2301.2109,1464,2297.2109" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1200" x2="1466" y1="2297.2109" y2="2297.2109"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="153" x="1207" y="2292.145">find_pending_recovery()</text><polygon fill="#000000" points="1211,2322.3438,1201,2326.3438,1211,2330.3438,1207,2326.3438" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1205" x2="1471" y1="2326.3438" y2="2326.3438"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="73" x="1217" y="2321.2778">pending list</text><path d="M15,2341.3438 L92,2341.3438 L92,2348.4766 L82,2358.4766 L15,2358.4766 L15,2341.3438 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="133.6641" style="stroke:#000000;stroke-width:1.0;" width="1529" x="15" y="2341.3438"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="32" x="30" y="2354.4106">loop</text><text fill="#000000" font-family="Verdana" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="156" x="107" y="2353.5542">[Each pending recovery]</text><polygon fill="#000000" points="193,2375.6094,183,2379.6094,193,2383.6094,189,2379.6094" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="187" x2="1199" y1="2379.6094" y2="2379.6094"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="255" x="199" y="2374.5435">send_message("Как восстановился?")</text><polygon fill="#000000" points="55,2404.7422,45,2408.7422,55,2412.7422,51,2408.7422" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="49" x2="181" y1="2408.7422" y2="2408.7422"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="114" x="61" y="2403.6763">recovery question</text><polygon fill="#000000" points="1460,2433.875,1470,2437.875,1460,2441.875,1464,2437.875" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1200" x2="1466" y1="2437.875" y2="2437.875"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="90" x="1207" y="2432.8091">mark_sent(...)</text><polygon fill="#000000" points="1211,2463.0078,1201,2467.0078,1211,2471.0078,1207,2467.0078" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1205" x2="1471" y1="2467.0078" y2="2467.0078"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="15" x="1217" y="2461.9419">ok</text><rect fill="#FFFFFF" height="3" style="stroke:#FFFFFF;stroke-width:1.0;" width="1916" x="5" y="2502.5742"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1921" y1="2502.5742" y2="2502.5742"/><line style="stroke:#000000;stroke-width:0.5;" x1="5" x2="1921" y1="2505.5742" y2="2505.5742"/><rect fill="#FFFFFF" height="23.1328" style="stroke:#000000;stroke-width:1.0;" width="144" x="891" y="2492.0078"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="125" x="897" y="2508.0747">Recovery answer</text><polygon fill="#000000" points="170,2542.2734,180,2546.2734,170,2550.2734,174,2546.2734" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="44" x2="176" y1="2546.2734" y2="2546.2734"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="84" x="51" y="2541.2075">recovery text</text><polygon fill="#000000" points="357,2571.4063,367,2575.4063,357,2579.4063,361,2575.4063" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="182" x2="363" y1="2575.4063" y2="2575.4063"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="122" x="189" y="2570.3403">Message(recovery)</text><polygon fill="#000000" points="1188,2600.5391,1198,2604.5391,1188,2608.5391,1192,2604.5391" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="369" x2="1194" y1="2604.5391" y2="2604.5391"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="228" x="376" y="2599.4731">save_recovery_feedback(user, text)</text><polygon fill="#000000" points="1460,2644.8047,1470,2648.8047,1460,2652.8047,1464,2648.8047" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="1200" x2="1466" y1="2648.8047" y2="2648.8047"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="191" x="1207" y="2628.606">update_recovery(feedback,...)</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="248" x="1207" y="2643.7388">+ merge into workout.ai_analysis JSON</text><polygon fill="#000000" points="1211,2673.9375,1201,2677.9375,1211,2681.9375,1207,2677.9375" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1205" x2="1471" y1="2677.9375" y2="2677.9375"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="15" x="1217" y="2672.8716">ok</text><polygon fill="#000000" points="380,2703.0703,370,2707.0703,380,2711.0703,376,2707.0703" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="374" x2="1199" y1="2707.0703" y2="2707.0703"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="15" x="386" y="2702.0044">ok</text><polygon fill="#000000" points="193,2732.2031,183,2736.2031,193,2740.2031,189,2736.2031" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="187" x2="368" y1="2736.2031" y2="2736.2031"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="71" x="199" y="2731.1372">"Спасибо!"</text><polygon fill="#000000" points="55,2761.3359,45,2765.3359,55,2769.3359,51,2765.3359" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="49" x2="181" y1="2765.3359" y2="2765.3359"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="80" x="61" y="2760.27">confirmation</text><!--MD5=[b773f44e99eafe8218d1525877ffb246]
@startuml
!theme plain
title Telegram Fitness Bot - Workout Lifecycle — Sequence Diagram (FSM, AI feedback, Recovery)

actor User
participant "Telegram" as TG
participant "Handlers (aiogram routers)" as H
participant "ScreenManager (UI)" as SM
participant "WorkoutService" as W
participant "AICoachService (AI-логика)" as AIc
participant "ReminderService (отлож. действия)" as R
participant "DB - данные" as DB
participant "AI Provider (внешний API - Groq)" as AI
participant "Scheduler" as SCH

== /start ==
User -> TG: /start
TG -> H: Message("/start")
note over H: Middlewares inject:\n- AsyncSession\n- get_or_create User\n- ScreenManager
H -> SM: show(main_menu)
SM - -> TG: welcome + menu
TG - -> User: menu

== Start Workout ==
User -> TG: "Тренировка"
TG -> H: Callback(workout_screen)
H -> W: can_start_workout(user)
W -> DB: check_active_workout(user)
DB - -> W: none/exists
alt Есть активная тренировка
  W - -> H: deny("workout already active")
  H -> SM: show(info_screen)
  SM - -> TG: info
else Can start
  W -> DB: create_workout(user)\n+ initial state
  DB - -> W: workout_id + state
  W - -> H: workout_started
  H -> SM: show(live_workout_screen)
  SM - -> TG: current exercise + input hint
end
TG - -> User: live workout

== Log sets (FSM waiting_input) ==
loop Each user input line
  User -> TG: "12 50"
  TG -> H: Message("12 50")
  H -> W: parse_set_input(text)
  W - -> H: reps, weight
  H -> W: add_set(workout_id, reps, weight)
  W -> DB: insert_workout_set(...)
  DB - -> W: ok
  W - -> H: ok
  H -> SM: refresh(live_workout_screen)
  SM - -> TG: updated sets
end

== Finish Workout ==
User -> TG: "Завершить"
TG -> H: Callback(finish)
H -> W: finish_workout(workout_id)
W -> DB: update_workout(status="finished")\n+ compute summary
DB - -> W: workout_summary
W - -> H: workout_summary

alt AI_ENABLED
  note over W: After finish, schedule recovery check
  H -> SM: show(feedback_prompt)\n(FSM waiting_feedback)
  SM - -> TG: "Как прошла тренировка?"
  TG - -> User: feedback prompt

  User -> TG: feedback text
  TG -> H: Message(feedback)
  H -> AIc: analyze_feedback(feedback, context)
  AIc -> DB: load_context(user, workout)
  DB - -> AIc: workouts/metrics/etc
  AIc -> AI: analyze(feedback + context)
  AI - -> AIc: structured analysis (RPE/notes)
  AIc -> DB: save_workout_feedback(workout, analysis)
  DB - -> AIc: ok

  AIc - -> H: ok
  H -> R: schedule_recovery_check(user, workout)
  R -> DB: create_recovery_record(...)
  DB - -> R: ok
else AI disabled
  note over H: Skip feedback + AI analysis
end

H -> SM: show(workout_report)
SM - -> TG: report
TG - -> User: report

== Recovery question (scheduled job) ==
SCH -> R: check_recovery_questions()
R -> DB: find_pending_recovery()
DB - -> R: pending list

loop Each pending recovery
  R -> TG: send_message("Как восстановился?")
  TG - -> User: recovery question
  R -> DB: mark_sent(...)
  DB - -> R: ok
end

== Recovery answer ==
User -> TG: recovery text
TG -> H: Message(recovery)
H -> R: save_recovery_feedback(user, text)
R -> DB: update_recovery(feedback,...)\n+ merge into workout.ai_analysis JSON
DB - -> R: ok
R - -> H: ok
H - -> TG: "Спасибо!"
TG - -> User: confirmation
@enduml

@startuml







<style>
  root {
    BackgroundColor white
    FontColor black
    FontName Verdana
    HyperLinkColor blue
    LineColor black
    LineThickness 1
    Margin 5
  }
  caption {
    LineThickness 0
  }
  footer {
    LineThickness 0
  }
  header {
    LineThickness 0
  }
  node {
    MaximumWidth 300
  }
  title {
    FontSize 22
    LineThickness 0
  }
</style>

skinparam ArrowLollipopColor black
skinparam BackgroundColor white
skinparam DefaultFontName Verdana
skinparam DefaultMonospacedFontName Courier
skinparam LifelineStrategy nosolid
skinparam ParticipantPadding 10
skinparam SequenceLifeLineBorderColor black
skinparam Shadowing false
skinparam UseBetaStyle true

skinparam Activity {
  BackgroundColor white
  BarColor black
  BorderColor black
  FontColor black
  FontName Verdana
}
skinparam Boundary {
  FontColor black
}
skinparam Box {
  Padding 5
}
skinparam CircledCharacter {
  FontColor black
  FontName Courier
  Radius 9
}
skinparam Class {
  BackgroundColor white
  BorderColor black
  FontColor black
  FontName Verdana
}
skinparam ClassAttribute {
  FontColor black
  FontName Verdana
}
skinparam ClassStereotype {
  FontColor black
  FontName Verdana
}
skinparam Footer {
  FontColor black
  FontName Verdana
}
skinparam Header {
  FontColor black
  FontName Verdana
}
skinparam Hyperlink {
  Color blue
}
skinparam IconPackage {
  Color black
  BackgroundColor white
}
skinparam IconPrivate {
  Color black
  BackgroundColor white
}
skinparam IconProtected {
  Color black
  BackgroundColor white
}
skinparam IconPublic {
  Color black
  BackgroundColor white
}
skinparam Note {
  FontColor black
  FontName Verdana
}
skinparam Object {
  BorderColor black
}
skinparam Package {
  BorderColor black
  FontColor black
  FontName Verdana
}
skinparam State {
  BackgroundColor white
  BorderColor black
}
skinparam StereotypeA {
  BackgroundColor white
  BorderColor black
}
skinparam StereotypeC {
  BackgroundColor white
  BorderColor black
}
skinparam StereotypeE {
  BackgroundColor white
  BorderColor black
}
skinparam StereotypeI {
  BackgroundColor white
  BorderColor black
}
skinparam StereotypeN {
  BackgroundColor white
  BorderColor black
}
skinparam UseCaseStereoType {
  FontColor black
  FontName Verdana
}
title Telegram Fitness Bot - Workout Lifecycle — Sequence Diagram (FSM, AI feedback, Recovery)

actor User
participant "Telegram" as TG
participant "Handlers (aiogram routers)" as H
participant "ScreenManager (UI)" as SM
participant "WorkoutService" as W
participant "AICoachService (AI-логика)" as AIc
participant "ReminderService (отлож. действия)" as R
participant "DB - данные" as DB
participant "AI Provider (внешний API - Groq)" as AI
participant "Scheduler" as SCH

== /start ==
User -> TG: /start
TG -> H: Message("/start")
note over H: Middlewares inject:\n- AsyncSession\n- get_or_create User\n- ScreenManager
H -> SM: show(main_menu)
SM - -> TG: welcome + menu
TG - -> User: menu

== Start Workout ==
User -> TG: "Тренировка"
TG -> H: Callback(workout_screen)
H -> W: can_start_workout(user)
W -> DB: check_active_workout(user)
DB - -> W: none/exists
alt Есть активная тренировка
  W - -> H: deny("workout already active")
  H -> SM: show(info_screen)
  SM - -> TG: info
else Can start
  W -> DB: create_workout(user)\n+ initial state
  DB - -> W: workout_id + state
  W - -> H: workout_started
  H -> SM: show(live_workout_screen)
  SM - -> TG: current exercise + input hint
end
TG - -> User: live workout

== Log sets (FSM waiting_input) ==
loop Each user input line
  User -> TG: "12 50"
  TG -> H: Message("12 50")
  H -> W: parse_set_input(text)
  W - -> H: reps, weight
  H -> W: add_set(workout_id, reps, weight)
  W -> DB: insert_workout_set(...)
  DB - -> W: ok
  W - -> H: ok
  H -> SM: refresh(live_workout_screen)
  SM - -> TG: updated sets
end

== Finish Workout ==
User -> TG: "Завершить"
TG -> H: Callback(finish)
H -> W: finish_workout(workout_id)
W -> DB: update_workout(status="finished")\n+ compute summary
DB - -> W: workout_summary
W - -> H: workout_summary

alt AI_ENABLED
  note over W: After finish, schedule recovery check
  H -> SM: show(feedback_prompt)\n(FSM waiting_feedback)
  SM - -> TG: "Как прошла тренировка?"
  TG - -> User: feedback prompt

  User -> TG: feedback text
  TG -> H: Message(feedback)
  H -> AIc: analyze_feedback(feedback, context)
  AIc -> DB: load_context(user, workout)
  DB - -> AIc: workouts/metrics/etc
  AIc -> AI: analyze(feedback + context)
  AI - -> AIc: structured analysis (RPE/notes)
  AIc -> DB: save_workout_feedback(workout, analysis)
  DB - -> AIc: ok

  AIc - -> H: ok
  H -> R: schedule_recovery_check(user, workout)
  R -> DB: create_recovery_record(...)
  DB - -> R: ok
else AI disabled
  note over H: Skip feedback + AI analysis
end

H -> SM: show(workout_report)
SM - -> TG: report
TG - -> User: report

== Recovery question (scheduled job) ==
SCH -> R: check_recovery_questions()
R -> DB: find_pending_recovery()
DB - -> R: pending list

loop Each pending recovery
  R -> TG: send_message("Как восстановился?")
  TG - -> User: recovery question
  R -> DB: mark_sent(...)
  DB - -> R: ok
end

== Recovery answer ==
User -> TG: recovery text
TG -> H: Message(recovery)
H -> R: save_recovery_feedback(user, text)
R -> DB: update_recovery(feedback,...)\n+ merge into workout.ai_analysis JSON
DB - -> R: ok
R - -> H: ok
H - -> TG: "Спасибо!"
TG - -> User: confirmation
@enduml

PlantUML version 1.2022.7(Mon Aug 22 17:01:30 UTC 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: null
--></g></svg>